# トーラムオンライン ダメージ計算ツール 技術仕様書

## 1. 概要
本仕様書は、トーラムオンライン ダメージ計算ツールの技術的な実装詳細とデータベース構造を定義します。

## 2. 技術スタック
- **フロントエンド**: Next.js 15 + React 19
- **言語**: TypeScript (strict mode)
- **スタイリング**: Tailwind CSS v4
- **フォームバリデーション**: Zod + React Hook Form
- **データ管理**: JSON + LocalStorage
- **コードフォーマット**: Biome

## 3. プロジェクト構造

```
src/
├── app/                    # Next.js App Router
├── components/             # Reactコンポーネント
├── types/                  # TypeScript型定義
├── schemas/                # Zodバリデーションスキーマ
├── data/                   # 静的データ（JSON）
├── utils/                  # ユーティリティ関数
└── hooks/                  # カスタムフック
```

## 4. データベース設計

### 4.1 装備データベース構造

#### 4.1.1 ファイル構成
- **メインデータ**: `src/data/equipments.json`
- **ユーザーカスタムデータ**: LocalStorage (`custom_equipments`)

#### 4.1.2 JSON構造

```json
{
  "equipments": {
    "mainWeapon": [装備アイテム配列],
    "body": [装備アイテム配列],
    "additional": [装備アイテム配列],
    "special": [装備アイテム配列],
    "subWeapon": [装備アイテム配列],
    "fashion1": [装備アイテム配列],
    "fashion2": [装備アイテム配列],
    "fashion3": [装備アイテム配列]
  }
}
```

#### 4.1.3 装備アイテム構造

```typescript
interface PresetEquipment {
  id: string                    // 一意識別子
  name: string                  // 装備名
  properties: Partial<EquipmentProperties> // 付与プロパティ
  source?: string              // 入手方法
  weaponStats?: WeaponStats    // mainWeaponカテゴリ専用：武器基本ステータス（オプション）
}

// mainWeaponカテゴリ専用の武器基本ステータス
interface WeaponStats {
  ATK?: number       // 武器ATK（省略時はWeaponFormの値を使用）
  stability?: number // 安定率（省略時はWeaponFormの値を使用）
  refinement?: number // 精錬値（省略時はWeaponFormの値を使用）
}
```

#### 4.1.4 装備プロパティ完全定義

```typescript
interface EquipmentProperties {
  // 基本攻撃力系
  ATK_Rate: number                     // ATK%
  ATK_Flat: number                     // ATK
  MATK_Rate: number                    // MATK%
  MATK_Flat: number                    // MATK
  WeaponATK_Rate: number               // 武器ATK%
  WeaponATK_Flat: number               // 武器ATK
  
  // 防御力系
  DEF_Rate: number                     // DEF%
  DEF_Flat: number                     // DEF
  MDEF_Rate: number                    // MDEF%
  MDEF_Flat: number                    // MDEF
  
  // 貫通系
  PhysicalPenetration_Rate: number     // 物理貫通%
  MagicalPenetration_Rate: number      // 魔法貫通%
  ElementAdvantage_Rate: number        // 属性有利%
  
  // 威力系
  UnsheatheAttack_Rate: number         // 抜刀威力%
  UnsheatheAttack_Flat: number         // 抜刀威力
  ShortRangeDamage_Rate: number        // 近距離威力%
  LongRangeDamage_Rate: number         // 遠距離威力%
  
  // クリティカル系
  CriticalDamage_Rate: number          // クリティカルダメージ%
  CriticalDamage_Flat: number          // クリティカルダメージ
  CriticalRate_Rate: number            // クリティカル率%
  CriticalRate_Flat: number            // クリティカル率
  
  // 安定率
  Stability_Rate: number               // 安定率%
  
  // HP/MP系
  HP_Rate: number                      // HP%
  HP_Flat: number                      // HP
  MP_Rate: number                      // MP%
  MP_Flat: number                      // MP
  
  // ステータス系
  STR_Rate: number                     // STR%
  STR_Flat: number                     // STR
  INT_Rate: number                     // INT%
  INT_Flat: number                     // INT
  VIT_Rate: number                     // VIT%
  VIT_Flat: number                     // VIT
  AGI_Rate: number                     // AGI%
  AGI_Flat: number                     // AGI
  DEX_Rate: number                     // DEX%
  DEX_Flat: number                     // DEX
  CRT_Rate: number                     // CRT%
  CRT_Flat: number                     // CRT
  MEN_Rate: number                     // MEN%
  MEN_Flat: number                     // MEN
  TEC_Rate: number                     // TEC%
  TEC_Flat: number                     // TEC
  LUK_Rate: number                     // LUK%
  LUK_Flat: number                     // LUK
  
  // 命中・回避系
  Accuracy_Rate: number                // 命中%
  Accuracy_Flat: number                // 命中
  Dodge_Rate: number                   // 回避%
  Dodge_Flat: number                   // 回避
  
  // 速度系
  AttackSpeed_Rate: number             // 攻撃速度%
  AttackSpeed_Flat: number             // 攻撃速度
  CastingSpeed_Rate: number            // 詠唱速度%
  CastingSpeed_Flat: number            // 詠唱速度
  MotionSpeed_Rate: number             // 行動速度%
  
  // MP回復系
  AttackMPRecovery_Rate: number        // 攻撃MP回復%
  AttackMPRecovery_Flat: number        // 攻撃MP回復
  
  // 耐性系
  PhysicalResistance_Rate: number      // 物理耐性%
  MagicalResistance_Rate: number       // 魔法耐性%
  AilmentResistance_Rate: number       // 異常耐性%
  
  // その他戦闘系
  Aggro_Rate: number                   // ヘイト%
  RevivalTime_Rate: number             // 復帰短縮%
  
  // 自然回復系
  NaturalHPRecovery_Rate: number       // HP自然回復%
  NaturalHPRecovery_Flat: number       // HP自然回復
  NaturalMPRecovery_Rate: number       // MP自然回復%
  NaturalMPRecovery_Flat: number       // MP自然回復
  
  // 特殊系
  ArmorBreak_Rate: number              // 防御崩し%
  Anticipate_Rate: number              // 先読み%
  GuardPower_Rate: number              // Guard力%
  GuardRecharge_Rate: number           // Guard回復%
  AvoidRecharge_Rate: number           // Avoid回復%
  ItemCooldown_Flat: number            // 道具速度
  AbsoluteAccuracy_Rate: number        // 絶対命中%
  AbsoluteDodge_Rate: number           // 絶対回避%
  
  // ステータス連動攻撃力
  ATK_STR_Rate: number                 // ATK+(STR)%
  ATK_INT_Rate: number                 // ATK+(INT)%
  ATK_VIT_Rate: number                 // ATK+(VIT)%
  ATK_AGI_Rate: number                 // ATK+(AGI)%
  ATK_DEX_Rate: number                 // ATK+(DEX)%
  MATK_STR_Rate: number                // MATK+(STR)%
  MATK_INT_Rate: number                // MATK+(INT)%
  MATK_VIT_Rate: number                // MATK+(VIT)%
  MATK_AGI_Rate: number                // MATK+(AGI)%
  MATK_DEX_Rate: number                // MATK+(DEX)%
  
  // 属性耐性
  FireResistance_Rate: number          // 火耐性%
  WaterResistance_Rate: number         // 水耐性%
  WindResistance_Rate: number          // 風耐性%
  EarthResistance_Rate: number         // 地耐性%
  LightResistance_Rate: number         // 光耐性%
  DarkResistance_Rate: number          // 闇耐性%
  NeutralResistance_Rate: number       // 無耐性%
  
  // ダメージ軽減系
  LinearReduction_Rate: number         // 直線軽減%
  RushReduction_Rate: number           // 突進軽減%
  BulletReduction_Rate: number         // 弾丸軽減%
  ProximityReduction_Rate: number      // 周囲軽減%
  AreaReduction_Rate: number           // 範囲軽減%
  FloorTrapReduction_Rate: number      // 痛床軽減%
  MeteorReduction_Rate: number         // 隕石軽減%
  BladeReduction_Rate: number          // 射刃軽減%
  SuctionReduction_Rate: number        // 吸引軽減%
  ExplosionReduction_Rate: number      // 爆発軽減%
  
  // バリア系
  PhysicalBarrier_Flat: number         // 物理バリア
  MagicalBarrier_Flat: number          // 魔法バリア
  FractionalBarrier_Flat: number       // 割合バリア
  BarrierCooldown_Rate: number         // バリア速度%
  
  // 追撃系
  PhysicalFollowup_Rate: number        // 物理追撃%
  MagicalFollowup_Rate: number         // 魔法追撃%
}
```

#### 4.1.5 装備カテゴリ定義

```typescript
type EquipmentCategory = 
  | 'mainWeapon'      // メイン装備
  | 'body'      // 体装備
  | 'additional' // 追加装備
  | 'special'   // 特殊装備
  | 'subWeapon' // サブ武器
  | 'fashion1'  // オシャレ装備1
  | 'fashion2'  // オシャレ装備2
  | 'fashion3'  // オシャレ装備3
```

### 4.2 クリスタルデータベース構造

#### 4.2.1 ファイル構成
- **メインデータ**: `src/data/crystals.json`
- **ユーザーカスタムデータ**: LocalStorage (`custom_crystals`)

#### 4.2.2 クリスタル構造

```typescript
interface PresetCrystal {
  id: string
  name: string
  type: CrystalType
  properties: Partial<EquipmentProperties>
}

type CrystalType = 'weapon' | 'armor' | 'additional' | 'special' | 'normal'
```

### 4.3 敵情報データベース構造

#### 4.3.1 ファイル構成
- **メインデータ**: `src/data/enemies.json`
- **ユーザーカスタムデータ**: LocalStorage (`custom_enemies`)

#### 4.3.2 JSON構造

```json
{
  "enemies": {
    "normal": [敵情報配列],
    "boss": [敵情報配列],
    "special": [敵情報配列]
  }
}
```

#### 4.3.3 敵情報構造

```typescript
interface PresetEnemy {
  id: string                    // 一意識別子
  name: string                  // 敵名
  level: number                 // レベル (1-510)
  stats: EnemyStats            // 基本ステータス
  properties: Partial<EnemyProperties> // 特殊プロパティ
  category: EnemyCategory      // 敵カテゴリ
  source?: string              // 出現場所
  description?: string         // 説明文
}

interface EnemyStats {
  DEF: number                  // 物理防御力 (0-9999)
  MDEF: number                 // 魔法防御力 (0-9999)
  criticalConfirmation: number // 確定クリティカル (0-999)
  requiredHIT: number          // 必要HIT (0-9999)
}

interface EnemyProperties {
  // 属性耐性
  FireResistance_Rate: number          // 火耐性%
  WaterResistance_Rate: number         // 水耐性%
  WindResistance_Rate: number          // 風耐性%
  EarthResistance_Rate: number         // 地耐性%
  LightResistance_Rate: number         // 光耐性%
  DarkResistance_Rate: number          // 闇耐性%
  NeutralResistance_Rate: number       // 無耐性%
  
  // 基本耐性
  PhysicalResistance_Rate: number      // 物理耐性%
  MagicalResistance_Rate: number       // 魔法耐性%
  AilmentResistance_Rate: number       // 異常耐性%
  
  // ダメージ軽減系
  LinearReduction_Rate: number         // 直線軽減%
  RushReduction_Rate: number           // 突進軽減%
  BulletReduction_Rate: number         // 弾丸軽減%
  ProximityReduction_Rate: number      // 周囲軽減%
  AreaReduction_Rate: number           // 範囲軽減%
  FloorTrapReduction_Rate: number      // 痛床軽減%
  MeteorReduction_Rate: number         // 隕石軽減%
  BladeReduction_Rate: number          // 射刃軽減%
  SuctionReduction_Rate: number        // 吸引軽減%
  ExplosionReduction_Rate: number      // 爆発軽減%
}

type EnemyCategory = 'normal' | 'boss' | 'special'
```

#### 4.1.6 mainWeapon装備の武器ステータス仕様

mainWeaponカテゴリの装備では、`weaponStats`フィールドで武器の基本ステータスを定義できます：

- **設定あり**: 装備データで定義された値を使用
- **設定なし**: WeaponFormで入力された値を使用
- **優先度**: `weaponStats` > WeaponForm入力値

```typescript
// 例：武器ステータスが設定された装備
{
  "id": "legendary_sword",
  "name": "レジェンダリーソード",
  "weaponStats": {
    "ATK": 500,
    "stability": 90,
    "refinement": 15
  },
  "properties": {
    "ATK%": 20,
    "クリティカル率%": 15
  }
}

// 例：武器ステータスが未設定の装備（WeaponFormの値を使用）
{
  "id": "basic_sword",
  "name": "ベーシックソード",
  "properties": {
    "ATK%": 10
  }
}
```

### 4.4 データ管理パターン

#### 4.4.1 データアクセス層
```typescript
// 装備データ取得
function getAllEquipments(): PresetEquipment[]
function getEquipmentsByCategory(category: EquipmentCategory): PresetEquipment[]
function getEquipmentById(id: string): PresetEquipment | null

// 敵情報データ取得
function getAllEnemies(): PresetEnemy[]
function getEnemiesByCategory(category: EnemyCategory): PresetEnemy[]
function getEnemyById(id: string): PresetEnemy | null

// ユーザーカスタムデータ管理
function getUserCustomEquipments(): PresetEquipment[]
function saveUserCustomEquipment(equipment: PresetEquipment): void
function deleteUserCustomEquipment(id: string): void

function getUserCustomEnemies(): PresetEnemy[]
function saveUserCustomEnemy(enemy: PresetEnemy): void
function deleteUserCustomEnemy(id: string): void

// 統合データ取得
function getAllAvailableEquipments(): PresetEquipment[]
function getAvailableEquipmentsByCategory(category: EquipmentCategory): PresetEquipment[]

function getAllAvailableEnemies(): PresetEnemy[]
function getAvailableEnemiesByCategory(category: EnemyCategory): PresetEnemy[]
```

#### 4.4.2 データバリデーション
- 全ての数値フィールドに適切な範囲制限
- 必須フィールドの検証
- 一意性制約（ID重複チェック）
- プロパティ値の型安全性保証

## 5. フォームバリデーション仕様

### 5.1 基本ステータスバリデーション
```typescript
const baseStatsSchema = z.object({
  STR: z.number().min(1).max(510),
  INT: z.number().min(1).max(510),
  VIT: z.number().min(1).max(510),
  AGI: z.number().min(1).max(510),
  DEX: z.number().min(1).max(510),
  CRT: z.number().min(1).max(255),
  MEN: z.number().min(1).max(255),
  TEC: z.number().min(1).max(255),
  LUK: z.number().min(1).max(255),
  level: z.number().min(1).max(510),
})
```

### 5.2 武器バリデーション
```typescript
const weaponSchema = z.object({
  weaponType: z.string(),
  ATK: z.number().min(0).max(1500),
  stability: z.number().min(0).max(100),
  refinement: z.number().min(0).max(15),
})
```

### 5.3 敵情報バリデーション
```typescript
const enemySchema = z.object({
  level: z.number().min(1).max(999),
  DEF: z.number().min(0).max(9999),
  MDEF: z.number().min(0).max(9999),
  criticalConfirmation: z.number().min(0).max(999),
  requiredHIT: z.number().min(0).max(9999),
})
```

## 6. LocalStorage設計

### 6.1 保存データ構造
```typescript
interface LocalStorageData {
  custom_equipments: PresetEquipment[]
  custom_crystals: PresetCrystal[]
  custom_enemies: PresetEnemy[]
  user_settings: UserSettings
  saved_builds: CalculatorData[]
}
```

### 6.2 データ同期パターン
- 読み込み時: プリセット + ユーザーカスタムを統合
- 保存時: ユーザーカスタムデータのみLocalStorageに保存
- エラーハンドリング: try-catchでLocalStorageアクセスエラーを処理

## 7. パフォーマンス最適化

### 7.1 データロード最適化
- 遅延ロード: 必要な装備カテゴリのみロード
- メモ化: 計算結果のキャッシュ
- バーチャルスクロール: 大量アイテム表示時

### 7.2 フォーム最適化
- debounce: 入力値変更の処理遅延
- 分割バリデーション: フィールド単位での検証
- 最適化されたrerender: 不要な再描画を防止

## 8. エラーハンドリング

### 8.1 データ読み込みエラー
- JSONパースエラー処理
- LocalStorageアクセスエラー処理
- フォールバック機能

### 8.2 バリデーションエラー
- リアルタイムエラー表示
- エラーメッセージの国際化対応
- ユーザビリティを考慮したエラー表示

## 9. 将来拡張設計

### 9.1 データ構造拡張
- 新装備カテゴリの追加容易性
- 新プロパティの追加容易性
- バージョン管理対応

### 9.2 機能拡張
- インポート/エクスポート機能
- 装備セット保存機能
- 最適化計算機能
- マルチユーザー対応準備