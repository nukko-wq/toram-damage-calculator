# トーラムオンライン ダメージ計算ツール 技術仕様書

## 1. 概要
本仕様書は、トーラムオンライン ダメージ計算ツールの技術的な実装詳細とデータベース構造を定義します。

## 2. 技術スタック
- **フロントエンド**: Next.js 15 + React 19
- **言語**: TypeScript (strict mode)
- **スタイリング**: Tailwind CSS v4
- **フォームバリデーション**: Zod + React Hook Form
- **データ管理**: JSON + LocalStorage
- **コードフォーマット**: Biome

## 3. プロジェクト構造

```
src/
├── app/                    # Next.js App Router
├── components/             # Reactコンポーネント
├── types/                  # TypeScript型定義
├── schemas/                # Zodバリデーションスキーマ
├── data/                   # 静的データ（JSON）
├── utils/                  # ユーティリティ関数
└── hooks/                  # カスタムフック
```

## 4. データベース設計

### 4.1 装備データベース構造

#### 4.1.1 ファイル構成
- **メインデータ**: `src/data/equipments.json`
- **ユーザーカスタムデータ**: LocalStorage (`custom_equipments`)

#### 4.1.2 JSON構造

```json
{
  "equipments": {
    "mainWeapon": [装備アイテム配列],
    "body": [装備アイテム配列],
    "additional": [装備アイテム配列],
    "special": [装備アイテム配列],
    "subWeapon": [装備アイテム配列],
    "fashion1": [装備アイテム配列],
    "fashion2": [装備アイテム配列],
    "fashion3": [装備アイテム配列]
  }
}
```

#### 4.1.3 装備アイテム構造

```typescript
interface PresetEquipment {
  id: string                    // 一意識別子
  name: string                  // 装備名
  properties: Partial<EquipmentProperties> // 付与プロパティ
  source?: string              // 入手方法
  weaponStats?: WeaponStats    // mainWeaponカテゴリ専用：武器基本ステータス（オプション）
}

// mainWeaponカテゴリ専用の武器基本ステータス
interface WeaponStats {
  ATK?: number       // 武器ATK（省略時はWeaponFormの値を使用）
  stability?: number // 安定率（省略時はWeaponFormの値を使用）
  refinement?: number // 精錬値（省略時はWeaponFormの値を使用）
}
```

#### 4.1.4 装備プロパティ完全定義

```typescript
interface EquipmentProperties {
  // 基本攻撃力系
  'ATK%': number
  'ATK': number
  'MATK%': number
  'MATK': number
  '武器ATK%': number
  '武器ATK': number
  
  // 防御力系
  'DEF%': number
  'DEF': number
  'MDEF%': number
  'MDEF': number
  
  // 貫通系
  '物理貫通%': number
  '魔法貫通%': number
  '属性有利%': number
  
  // 威力系
  '抜刀威力%': number
  '抜刀威力': number
  '近距離威力%': number
  '遠距離威力%': number
  
  // クリティカル系
  'クリティカルダメージ%': number
  'クリティカルダメージ': number
  'クリティカル率%': number
  'クリティカル率': number
  
  // 安定率
  '安定率%': number
  
  // HP/MP系
  'HP%': number
  'HP': number
  'MP%': number
  'MP': number
  
  // ステータス系
  'STR%': number
  'STR': number
  'INT%': number
  'INT': number
  'VIT%': number
  'VIT': number
  'AGI%': number
  'AGI': number
  'DEX%': number
  'DEX': number
  'CRT%': number
  'CRT': number
  'MEN%': number
  'MEN': number
  'TEC%': number
  'TEC': number
  'LUK%': number
  'LUK': number
  
  // 命中・回避系
  '命中%': number
  '命中': number
  '回避%': number
  '回避': number
  
  // 速度系
  '攻撃速度%': number
  '攻撃速度': number
  '詠唱速度%': number
  '詠唱速度': number
  '行動速度%': number
  
  // MP回復系
  '攻撃MP回復%': number
  '攻撃MP回復': number
  
  // 耐性系
  '物理耐性%': number
  '魔法耐性%': number
  '異常耐性%': number
  
  // その他戦闘系
  'ヘイト%': number
  '復帰短縮%': number
  
  // 自然回復系
  'HP自然回復%': number
  'HP自然回復': number
  'MP自然回復%': number
  'MP自然回復': number
  
  // 特殊系
  '防御崩し%': number
  '先読み%': number
  'Guard力%': number
  'Guard回復%': number
  'Avoid回復%': number
  '道具速度': number
  '絶対命中%': number
  '絶対回避%': number
  
  // ステータス連動攻撃力
  'ATK+(STR)%': number
  'ATK+(INT)%': number
  'ATK+(VIT)%': number
  'ATK+(AGI)%': number
  'ATK+(DEX)%': number
  'MATK+(STR)%': number
  'MATK+(INT)%': number
  'MATK+(VIT)%': number
  'MATK+(AGI)%': number
  'MATK+(DEX)%': number
  
  // 属性耐性
  '火耐性%': number
  '水耐性%': number
  '風耐性%': number
  '地耐性%': number
  '光耐性%': number
  '闇耐性%': number
  '無耐性%': number
  
  // ダメージ軽減系
  '直線軽減%': number
  '突進軽減%': number
  '弾丸軽減%': number
  '周囲軽減%': number
  '範囲軽減%': number
  '痛床軽減%': number
  '隕石軽減%': number
  '射刃軽減%': number
  '吸引軽減%': number
  '爆発軽減%': number
  
  // バリア系
  '物理バリア': number
  '魔法バリア': number
  '割合バリア': number
  'バリア速度%': number
  
  // 追撃系
  '物理追撃%': number
  '魔法追撃%': number
}
```

#### 4.1.5 装備カテゴリ定義

```typescript
type EquipmentCategory = 
  | 'mainWeapon'      // メイン装備
  | 'body'      // 体装備
  | 'additional' // 追加装備
  | 'special'   // 特殊装備
  | 'subWeapon' // サブ武器
  | 'fashion1'  // オシャレ装備1
  | 'fashion2'  // オシャレ装備2
  | 'fashion3'  // オシャレ装備3
```

### 4.2 クリスタルデータベース構造

#### 4.2.1 ファイル構成
- **メインデータ**: `src/data/crystals.json`
- **ユーザーカスタムデータ**: LocalStorage (`custom_crystals`)

#### 4.2.2 クリスタル構造

```typescript
interface PresetCrystal {
  id: string
  name: string
  type: CrystalType
  slots: CrystalSlotType[]
  properties: Partial<EquipmentProperties>
}

type CrystalType = 'dedicated' | 'normal'
type CrystalSlotType = 'weapon' | 'armor' | 'additional' | 'special'
```

#### 4.1.6 mainWeapon装備の武器ステータス仕様

mainWeaponカテゴリの装備では、`weaponStats`フィールドで武器の基本ステータスを定義できます：

- **設定あり**: 装備データで定義された値を使用
- **設定なし**: WeaponFormで入力された値を使用
- **優先度**: `weaponStats` > WeaponForm入力値

```typescript
// 例：武器ステータスが設定された装備
{
  "id": "legendary_sword",
  "name": "レジェンダリーソード",
  "weaponStats": {
    "ATK": 500,
    "stability": 90,
    "refinement": 15
  },
  "properties": {
    "ATK%": 20,
    "クリティカル率%": 15
  }
}

// 例：武器ステータスが未設定の装備（WeaponFormの値を使用）
{
  "id": "basic_sword",
  "name": "ベーシックソード",
  "properties": {
    "ATK%": 10
  }
}
```

### 4.3 データ管理パターン

#### 4.3.1 データアクセス層
```typescript
// プリセットデータ取得
function getAllEquipments(): PresetEquipment[]
function getEquipmentsByCategory(category: EquipmentCategory): PresetEquipment[]
function getEquipmentById(id: string): PresetEquipment | null

// ユーザーカスタムデータ管理
function getUserCustomEquipments(): PresetEquipment[]
function saveUserCustomEquipment(equipment: PresetEquipment): void
function deleteUserCustomEquipment(id: string): void

// 統合データ取得
function getAllAvailableEquipments(): PresetEquipment[]
function getAvailableEquipmentsByCategory(category: EquipmentCategory): PresetEquipment[]
```

#### 4.3.2 データバリデーション
- 全ての数値フィールドに適切な範囲制限
- 必須フィールドの検証
- 一意性制約（ID重複チェック）
- プロパティ値の型安全性保証

## 5. フォームバリデーション仕様

### 5.1 基本ステータスバリデーション
```typescript
const baseStatsSchema = z.object({
  STR: z.number().min(1).max(510),
  INT: z.number().min(1).max(510),
  VIT: z.number().min(1).max(510),
  AGI: z.number().min(1).max(510),
  DEX: z.number().min(1).max(510),
  CRT: z.number().min(1).max(255),
  MEN: z.number().min(1).max(255),
  TEC: z.number().min(1).max(255),
  LUK: z.number().min(1).max(255),
  level: z.number().min(1).max(510),
})
```

### 5.2 武器バリデーション
```typescript
const weaponSchema = z.object({
  weaponType: z.string(),
  ATK: z.number().min(0).max(1500),
  stability: z.number().min(0).max(100),
  refinement: z.number().min(0).max(15),
})
```

## 6. LocalStorage設計

### 6.1 保存データ構造
```typescript
interface LocalStorageData {
  custom_equipments: PresetEquipment[]
  custom_crystals: PresetCrystal[]
  user_settings: UserSettings
  saved_builds: CalculatorData[]
}
```

### 6.2 データ同期パターン
- 読み込み時: プリセット + ユーザーカスタムを統合
- 保存時: ユーザーカスタムデータのみLocalStorageに保存
- エラーハンドリング: try-catchでLocalStorageアクセスエラーを処理

## 7. パフォーマンス最適化

### 7.1 データロード最適化
- 遅延ロード: 必要な装備カテゴリのみロード
- メモ化: 計算結果のキャッシュ
- バーチャルスクロール: 大量アイテム表示時

### 7.2 フォーム最適化
- debounce: 入力値変更の処理遅延
- 分割バリデーション: フィールド単位での検証
- 最適化されたrerender: 不要な再描画を防止

## 8. エラーハンドリング

### 8.1 データ読み込みエラー
- JSONパースエラー処理
- LocalStorageアクセスエラー処理
- フォールバック機能

### 8.2 バリデーションエラー
- リアルタイムエラー表示
- エラーメッセージの国際化対応
- ユーザビリティを考慮したエラー表示

## 9. 将来拡張設計

### 9.1 データ構造拡張
- 新装備カテゴリの追加容易性
- 新プロパティの追加容易性
- バージョン管理対応

### 9.2 機能拡張
- インポート/エクスポート機能
- 装備セット保存機能
- 最適化計算機能
- マルチユーザー対応準備