# ローカルストレージ設計 - 概要・全体構造

## 概要

**目的**: トーラムオンライン ダメージ計算ツールにおけるローカルストレージを活用したデータ永続化とセーブデータ管理システムの設計

**対象データ**:
- **セーブデータ**：計算機の全入力状態（キャラステータス、装備選択、クリスタル選択等）
- **プリセットデータ（ローカル管理）**：システム提供データをローカルストレージで管理
- **ユーザーカスタム装備**：全セーブデータで共有される独自装備データ
- **ユーザーカスタムクリスタル**：全セーブデータで共有される独自クリスタルデータ
- **ユーザーカスタム敵情報**：全セーブデータで共有される独自敵情報データ
- **バフスキル設定**：各セーブデータに含まれるバフスキル有効/無効とパラメータ設定
- **バフアイテム設定**：各セーブデータに含まれるバフアイテム選択状態

## データアーキテクチャ

### データ分離の概念
- セーブデータは「どの装備・クリスタル・敵情報を選択したか」の参照情報のみ保存
- カスタム装備・クリスタル・敵情報は独立したデータとして管理
- 全セーブデータから同じカスタムデータプールを参照可能

### 分離設計のメリット
- データ重複の排除（同じカスタムアイテムを複数セーブデータで使用可能）
- ストレージ容量の効率化
- カスタムデータの一元管理
- セーブデータ間でのカスタムアイテム共有

## LocalStorage キー設計

```typescript
const STORAGE_KEYS = {
  // セーブデータ（参照情報のみ）
  SAVE_DATA_LIST: 'toram_save_data_list',           // SaveData[]
  CURRENT_SAVE_ID: 'toram_current_save_id',         // string
  
  // プリセットデータ（コピー済み、お気に入り・編集可能）
  PRESET_EQUIPMENTS: 'toram_preset_equipments',     // Equipment[]
  PRESET_CRYSTALS: 'toram_preset_crystals',         // Crystal[]
  PRESET_ENEMIES: 'toram_preset_enemies',           // Enemy[]
  PRESET_BUFF_ITEMS: 'toram_preset_buff_items',     // BuffItem[]
  PRESET_VERSION: 'toram_preset_version',           // VersionInfo
  
  // ユーザーカスタムデータ（全セーブデータで共有）
  CUSTOM_EQUIPMENTS: 'toram_custom_equipments',     // UserEquipment[]
  CUSTOM_CRYSTALS: 'toram_custom_crystals',         // UserCrystal[]
  CUSTOM_ENEMIES: 'toram_custom_enemies',           // UserEnemy[]
  
  // システム設定
  APP_SETTINGS: 'toram_app_settings',               // AppSettings
  STORAGE_STATS: 'toram_storage_stats'              // StorageStats
}
```

## プリセットデータ更新の課題と解決方法

### 課題
システム側でプリセットデータが更新された場合（新敵情報追加、装備追加等）、既存ユーザーが新しいデータにアクセスできるようにする必要がある。

### 解決方法：バージョン管理システム
- プリセットデータにバージョン情報を付与
- アプリ起動時にバージョンチェック
- 新バージョン検出時に差分更新実行
- ユーザー編集済みデータの保護

### バージョン管理の仕組み

**プリセットデータバージョン情報**:
```json
{
  "version": "1.2.0",
  "releaseDate": "2025-01-17",
  "equipments": {
    "version": "1.1.0",
    "checksum": "abc123def456"
  },
  "crystals": {
    "version": "1.0.1", 
    "checksum": "def456ghi789"
  },
  "enemies": {
    "version": "1.2.0",
    "checksum": "ghi789jkl012"
  }
}
```

**バージョンチェック方式**:
- 各プリセットデータファイル（装備、クリスタル、敵情報）に個別バージョン
- チェックサムによるデータ整合性確認
- セマンティックバージョニング（major.minor.patch）

## アプリ起動時の初期化フロー

```
アプリ起動 
→ ストレージチェック 
→ プリセットデータバージョンチェック 
→ [バージョン更新有り]プリセットデータ差分更新 
→ メインデータ存在確認 
→ [存在しない場合]メインデータ作成 
→ メインデータを現在のセーブデータに設定 
→ アプリ開始
```

**初期化処理**:
1. **バージョンチェック・プリセットデータ更新**:
   - ローカルストレージの現在バージョンを取得
   - システム側の最新バージョンと比較
   - 新バージョンが存在する場合、差分更新を実行
   - 初回アクセスの場合、プリセットデータの全コピーを実行
2. LocalStorageの`SAVE_DATA_LIST`キーをチェック
3. メインデータ（id: "default"）の存在確認
4. 存在しない場合、デフォルト値でメインデータを作成
5. `CURRENT_SAVE_ID`を"default"に設定
6. 各フォームにデフォルト値を適用

## データサイズ管理

**容量制限**:
- LocalStorage標準制限: 5-10MB
- 推定データ使用量:
  - プリセットデータ: 約1-2MB
  - セーブデータ: 1セーブあたり約10-50KB
  - カスタムデータ: ユーザーによって可変
  - 合計推定: 2-5MB

**容量監視機能**:
```typescript
interface StorageStats {
  totalSize: number      // 使用中のストレージサイズ（バイト）
  estimatedLimit: number // 推定制限サイズ
  usagePercentage: number // 使用率（%）
  lastChecked: string    // 最終チェック日時
}
```

## 技術仕様

### 依存関係
- **バリデーション**: Zod（データ検証）
- **型安全性**: TypeScript（全データに型定義）
- **ストレージAPI**: localStorage（ブラウザ標準）
- **暗号化**: 現時点では実装しない（将来拡張で検討）

### パフォーマンス最適化
- 遅延読み込み（必要な時のみストレージアクセス）
- データキャッシュ（頻繁にアクセスするデータのメモリキャッシュ）
- バッチ処理（複数データの一括更新）
- 非同期処理（重い処理のPromise化）

## セキュリティ・プライバシー

### データ保護
- **ローカル限定**: 全データはユーザーのブラウザローカルストレージのみに保存
- **外部送信なし**: データは外部サーバーに送信されない
- **プライバシー保護**: 個人を特定可能な情報は収集・保存しない
- **透明性**: オープンソースでデータ処理内容を公開

### 将来の共有機能
セーブデータ共有機能を実装する場合:
- セーブデータのエクスポート/インポート機能（JSONファイル）
- URL形式での設定共有（URLパラメータでの設定エンコード）
- 外部サーバーを使用した共有（別途プライバシーポリシー策定）

## 関連ドキュメント

- [セーブデータ管理](./save-data-storage.md) - セーブデータの詳細設計
- [カスタムデータ管理](./custom-data-storage.md) - ユーザーカスタムデータの管理
- [データ同期・バージョン管理](./data-sync.md) - プリセットデータの更新システム
- [パフォーマンス・エラーハンドリング](./storage-optimization.md) - 最適化とエラー処理