# StatusPreview機能要件

## 概要

StatusPreviewは、ヘッダー下に配置されるステータス計算結果の詳細表示機能です。98項目の詳細ステータス情報を4つのセクションに整理表示し、正確なトーラムオンライン計算式を使用したリアルタイム統合・計算処理を提供します。

## 機能要件

### 1. 統合計算機能

#### 1.1 データ統合処理
- 全入力フォーム（BaseStats, Weapon, Crystal, Equipment, Enemy）からデータを統合
- リアルタイム計算結果の生成
- 計算結果の自動更新（データ変更時）

#### 1.2 計算式実装
- **HP計算**: `HP = INT(INT(93+(補正後VIT+22.41)*Lv/3)*(1+HP%/100))+HP固定値`
- **MP計算**: `MP = INT(INT(Lv+99+TEC+総INT/10)*(1+MP%/100))+MP固定値`
- **ATK計算**: 基礎ATK、武器ATK、補正値を統合
- **その他95項目**: 段階的な実装

### 2. 表示機能

#### 2.1 98項目ステータス表示
- **基本ステータス**: 30項目（HP, MP, ATK, baseATK, 安定率など）
- **補正後ステータス**: 8項目（STR, AGI, INT, DEX, VIT, CRT, MEN, TEC）
- **装備品補正値1**: 31項目（物理関連、基本ステータス補正）
- **装備品補正値2**: 32項目（耐性、バリア、軽減系）
- **装備品補正値3**: 8項目（特殊効果、回復系）

#### 2.2 セクション構成
- 4つのセクションを適切にグループ化
- 各セクションは統一されたフォーマットで表示
- 計算結果の数値表示（小数点処理、単位表示）

### 3. ユーザビリティ要件

#### 3.1 レスポンシブ対応
- **モバイル**: 1列表示
- **タブレット**: 2列表示
- **デスクトップ**: 4列表示

#### 3.2 表示制御
- ResultToggleBarからの表示/非表示制御
- スライドダウン/アップアニメーション
- 適切なトランジション効果

## データ構造要件

### 1. 入力データ

```typescript
interface CalculatorData {
  baseStats: BaseStats        // 基本ステータス
  mainWeapon: WeaponData     // メイン武器
  subWeapon: WeaponData      // サブ武器
  crystals: CrystalData[]    // クリスタル配置
  equipment: EquipmentData[] // 装備品
  foods: FoodData[]          // 料理
  buffs: BuffData[]          // バフ
  enemy: EnemyData           // 敵情報
}
```

### 2. 計算結果データ

```typescript
interface CalculationResults {
  basicStats: BasicStatsResult        // 30項目
  adjustedStats: AdjustedStatsResult  // 8項目
  equipmentBonus1: EquipmentBonus1    // 31項目
  equipmentBonus2: EquipmentBonus2    // 32項目
  equipmentBonus3: EquipmentBonus3    // 8項目
}
```

### 3. 補正値データ

```typescript
interface AllBonuses {
  // 基本ステータス補正
  VIT?: number          // VIT固定値
  VIT_Rate?: number     // VIT%
  HP?: number           // HP固定値
  HP_Rate?: number      // HP%
  MP?: number           // MP固定値
  MP_Rate?: number      // MP%
  
  // 戦闘ステータス補正
  ATK?: number          // ATK固定値
  ATK_Rate?: number     // ATK%
  MATK?: number         // MATK固定値
  MATK_Rate?: number    // MATK%
  
  // その他93項目の補正値...
}
```

## 計算ロジック要件

### 1. 基本ステータス計算

#### 1.1 HP計算段階
1. 補正後VIT = ステータスVIT × (1 + VIT%/100) + VIT固定値
2. HP基本値 = INT(93 + (補正後VIT + 22.41) × Lv / 3)
3. HP%適用後 = INT(HP基本値 × (1 + HP%/100))
4. 最終HP = HP%適用後 + HP固定値

#### 1.2 MP計算段階
1. MP基本値 = INT(Lv + 99 + TEC + 総INT/10)
2. MP%適用後 = INT(MP基本値 × (1 + MP%/100))
3. 最終MP = MP%適用後 + MP固定値

### 2. 補正値統合

#### 2.1 装備品補正値計算
- 8スロット装備品の補正値を統合
- プロパティ効果の適用
- 精錬値による補正

#### 2.2 クリスタル効果計算
- 8スロットクリスタルの効果を統合
- 通常クリスタルとタイプクリスタルの効果適用
- スロット制限の考慮

#### 2.3 バフ効果計算
- 料理効果の適用
- バフスキル効果の適用
- バフアイテム効果の適用
- 効果時間と重複制限の考慮

### 3. 統合計算処理

#### 3.1 計算順序
1. 基本ステータス取得
2. 武器データ統合
3. 装備プロパティ統合
4. クリスタル効果統合
5. バフ効果統合
6. 最終計算処理

#### 3.2 エラーハンドリング
- 計算不可能な値の処理
- 異常値の検出と修正
- フォールバック値の提供

## パフォーマンス要件

### 1. 計算性能
- 計算時間: 100ms以下（98項目すべて）
- メモリ使用量: 最適化された中間データ保持
- CPU使用率: 効率的な計算アルゴリズム

### 2. レンダリング性能
- 初回レンダリング: 200ms以下
- 再レンダリング: 50ms以下
- アニメーション: 60fps維持

### 3. 最適化戦略
- 必要時のみ再計算
- 結果のメモ化
- 差分計算の活用

## 品質要件

### 1. 精度要件
- 計算精度: ゲーム内計算式との完全一致
- 端数処理: INT()関数による正確な切り捨て
- 検証: 実測値との比較検証

### 2. 安定性要件
- エラー率: 0.01%以下
- 異常終了: 0回（適切なエラーハンドリング）
- データ整合性: 100%保証

### 3. 保守性要件
- コード可読性: TypeScriptによる型安全性
- テスタビリティ: 単体テスト可能な構造
- 拡張性: 新項目追加の容易さ

## 実装制約

### 1. 技術制約
- フレームワーク: Next.js 15 + React 19
- 言語: TypeScript（strict mode）
- 状態管理: Zustand
- スタイリング: Tailwind CSS v4

### 2. 設計制約
- 関数型プログラミング: 純粋関数による計算
- イミュータブル: 状態の不変性維持
- 責任分離: 計算ロジックとUI表示の分離

### 3. データ制約
- データソース: プリセット + ユーザーカスタム
- 更新頻度: リアルタイム（データ変更時）
- データ形式: JSON + TypeScript型定義

## 今後の拡張

### Phase 1: 基本機能（現在）
- HP・MP計算の実装
- 基本的な表示機能

### Phase 2: 98項目完全実装
- 全ステータス計算エンジン
- 4セクション完全表示

### Phase 3: 補正値自動集計
- 装備・クリスタル・バフ統合
- リアルタイム計算更新

### Phase 4: 高度な機能
- 計算過程の詳細表示
- 複数ビルド比較
- パフォーマンス分析

## 関連要件
- [基本システム要件](./01_basic-system.md)
- [武器システム要件](./02_weapon-system.md)
- [装備システム要件](./03_equipment-system.md)
- [計算結果要件](./07_calculation-result.md)
- [UI/UX要件](./08_ui-ux-requirements.md)