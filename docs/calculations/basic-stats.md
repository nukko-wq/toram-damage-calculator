# 基本ステータス計算式

## 概要
キャラクターの基本的な生存力を表すHPとMPの計算式と、補正後基本ステータス（STR/INT/VIT/AGI/DEX）の計算式について記述する。

**重要**: 2024年統一により、AllBonusesインターフェースはEquipmentPropertiesと同じ命名規則（PascalCase + アンダースコア）を使用。例：`STR_Rate`, `HP_Rate`, `AttackMPRecovery_Rate`

## 数値処理に関する重要事項

### INT()関数について
本ドキュメント内で使用される`INT(数値)`は小数点以下を元の数値より小さい整数に切り捨てる関数です。

**重要な注意点:**
- 例: INT(-2.7) = -3
- ※ステータスのINTと混同しないように注意してください

### 計算における端数処理
- **HP・MP計算**: INT()関数による切り捨て処理を2段階で実施
- **負数の切り捨て**: INT(-2.7) = -3（より小さい整数への切り捨て）
- **整数計算**: 各計算段階で小数点以下切り捨て処理が重要

## 補正後基本ステータス計算

### STR（筋力）
```
補正後STR = INT(基礎STR × (1 + STR%/100)) + STR固定値
```

### INT（知力）
```
補正後INT = INT(基礎INT × (1 + INT%/100)) + INT固定値
```

### VIT（体力）
```
補正後VIT = INT(基礎VIT × (1 + VIT%/100)) + VIT固定値
```

### AGI（敏捷）
```
補正後AGI = INT(基礎AGI × (1 + AGI%/100)) + AGI固定値
```

### DEX（器用）
```
補正後DEX = INT(基礎DEX × (1 + DEX%/100)) + DEX固定値
```

### 計算例（STR）
**入力値:**
- 基礎STR: 200
- STR%: 15% (装備+クリスタ+バフアイテム)
- STR固定値: 30 (装備+クリスタ+バフアイテム)

**計算手順:**
1. 基礎STR × (1 + STR%/100) = 200 × (1 + 15/100) = 200 × 1.15 = 230
2. INT(230) = 230
3. 補正後STR = 230 + 30 = 260

### 構成要素
**%補正値の構成:**
- 装備/プロパティのステータス%補正
- セットしてあるクリスタのステータス%補正
- バフアイテムのステータス%補正
- 料理のステータス%補正

**固定値の構成:**
- 装備/プロパティのステータス固定値補正
- セットしてあるクリスタのステータス固定値補正
- バフアイテムのステータス固定値補正
- 料理のステータス固定値補正

## HP（ヒットポイント）計算

### 基本計算式
```
HP = INT(INT(93+(補正後VIT+22.41)*Lv/3)*(1+HP%/100))+HP固定値
```


### 詳細計算

#### 1. 補正後VIT計算
```
補正後VIT = ステータスのVIT × (1 + VIT%/100) + VIT固定値
```

**構成要素:**
- **VIT%**: 装備/プロパティとセットしてあるクリスタ、バフアイテムのVIT%の合計
- **VIT固定値**: 装備/プロパティとセットしてあるクリスタ、バフアイテムのVIT固定値の合計

**計算例:**
- ステータスのVIT: 200
- VIT%: 15% (装備+クリスタ)
- VIT固定値: 30 (装備+クリスタ)
- 補正後VIT = 200 × (1 + 15/100) + 30 = 200 × 1.15 + 30 = 230 + 30 = 260

#### 2. HP基本値計算
```
HP基本値 = INT(93 + (補正後VIT + 22.41) × Lv / 3)
```

**計算例:**
- 補正後VIT: 260
- Lv: 150
- HP基本値 = INT(93 + (260 + 22.41) × 150 / 3)
- HP基本値 = INT(93 + 282.41 × 50)
- HP基本値 = INT(93 + 14120.5)
- HP基本値 = INT(14213.5) = 14213

#### 3. HP%補正適用
```
HP%適用後 = INT(HP基本値 × (1 + HP%/100))
```

**構成要素:**
- **HP%**: 装備/プロパティとセットしてあるクリスタ、バフアイテムのHP%の合計

**計算例:**
- HP基本値: 14213
- HP%: 25% (装備+クリスタ+バフアイテム)
- HP%適用後 = INT(14213 × (1 + 25/100))
- HP%適用後 = INT(14213 × 1.25)
- HP%適用後 = INT(17766.25) = 17766

#### 4. 最終HP計算
```
最終HP = HP%適用後 + HP固定値
```

**構成要素:**
- **HP固定値**: 装備/プロパティとセットしてあるクリスタ、バフアイテムのHP固定値の合計

**計算例:**
- HP%適用後: 17766
- HP固定値: 200 (装備+クリスタ+バフアイテム)
- 最終HP = 17766 + 200 = 17966

### 完全計算例
**入力値:**
- ステータスのVIT: 200
- Lv: 150
- VIT%: 15%
- VIT固定値: 30
- HP%: 25%
- HP固定値: 200

**計算手順:**
1. 補正後VIT = 200 × (1 + 15/100) + 30 = 260
2. HP基本値 = INT(93 + (260 + 22.41) × 150 / 3) = INT(14213.5) = 14213
3. HP%適用後 = INT(14213 × (1 + 25/100)) = INT(17766.25) = 17766
4. 最終HP = 17766 + 200 = 17966

## MP（マジックポイント）計算

### 基本計算式
```
MP = INT(INT(Lv+99+TEC+補正後INT/10)*(1+MP%/100))+MP固定値
```


### 詳細計算

#### 1. 補正後INT計算
```
補正後INT = INT(基礎INT × (1 + INT%/100)) + INT固定値
```

**構成要素:**
- **INT%**: 装備/プロパティとセットしてあるクリスタ、バフアイテムのINT%の合計
- **INT固定値**: 装備/プロパティとセットしてあるクリスタ、バフアイテムのINT固定値の合計

**計算例:**
- 基礎INT: 200
- INT%: 10% (装備+クリスタ)
- INT固定値: 20 (装備+クリスタ)
- 補正後INT = INT(200 × (1 + 10/100)) + 20 = INT(200 × 1.10) + 20 = INT(220) + 20 = 240

#### 2. MP基本値計算
```
MP基本値 = INT(Lv + 99 + TEC + 補正後INT/10)
```

**構成要素:**
- **Lv**: ステータスのレベル
- **TEC**: ステータスのTEC
- **補正後INT**: 上記で計算した補正後INT

**計算例:**
- Lv: 150
- TEC: 80
- 補正後INT: 240
- MP基本値 = INT(150 + 99 + 80 + 240/10)
- MP基本値 = INT(150 + 99 + 80 + 24)
- MP基本値 = INT(353) = 353

#### 2. MP%補正適用
```
MP%適用後 = INT(MP基本値 × (1 + MP%/100))
```

**構成要素:**
- **MP%**: 装備/プロパティとセットしてあるクリスタ、バフアイテムのMP%の合計

**計算例:**
- MP基本値: 353
- MP%: 30% (装備+クリスタ+バフアイテム)
- MP%適用後 = INT(353 × (1 + 30/100))
- MP%適用後 = INT(353 × 1.30)
- MP%適用後 = INT(458.9) = 458

#### 3. 最終MP計算
```
最終MP = MP%適用後 + MP固定値
```

**構成要素:**
- **MP固定値**: 装備/プロパティとセットしてあるクリスタ、バフアイテムのMP固定値の合計

**計算例:**
- MP%適用後: 458
- MP固定値: 100 (装備+クリスタ+バフアイテム)
- 最終MP = 458 + 100 = 558

### 完全計算例
**入力値:**
- Lv: 150
- TEC: 80
- 基礎INT: 200
- INT%: 10%
- INT固定値: 20
- MP%: 30%
- MP固定値: 100

**計算手順:**
1. 補正後INT = INT(200 × (1 + 10/100)) + 20 = INT(220) + 20 = 240
2. MP基本値 = INT(150 + 99 + 80 + 240/10) = INT(353) = 353
3. MP%適用後 = INT(353 × (1 + 30/100)) = INT(458.9) = 458
4. 最終MP = 458 + 100 = 558

## 実装における注意点

### 端数処理
- **HP計算**: INT()関数による切り捨て処理を2段階で実施
  - HP基本値計算時: `INT(93+(補正後VIT+22.41)*Lv/3)`
  - HP%適用時: `INT(HP基本値*(1+HP%/100))`
- **MP計算**: INT()関数による切り捨て処理を2段階で実施
  - MP基本値計算時: `INT(Lv+99+TEC+総INT/10)`
  - MP%適用時: `INT(MP基本値*(1+MP%/100))`

## 異常耐性計算

### 基本計算式
```
異常耐性(%) = INT(MEN/3.4) + 異常耐性%
```


### 詳細計算

#### 構成要素
- **MEN**: ステータスのMEN（基本値、装備補正なし）
- **異常耐性%**: 装備/プロパティ、クリスタ、バフアイテム、料理からの異常耐性%補正の合計

#### 計算例
**入力値:**
- MEN: 100
- 異常耐性%: 15% (装備+クリスタ+バフアイテム)

**計算手順:**
1. MEN基礎計算 = INT(100/3.4) = INT(29.41) = 29
2. 最終異常耐性 = 29 + 15 = 44%

## FLEE（回避率）計算

### 基本計算式
```
FLEE = INT(基礎FLEE × (1 + 回避%/100)) + 回避固定値
```

### 基礎FLEE計算（体装備とArmorTypeに依存）

体装備の状態とArmorTypeによって基礎FLEE計算式が変わります：

#### 体装備なし
```
基礎FLEE = INT(75 + Lv × 3/2 + 補正後AGI × 2)
```

#### 体装備あり（通常）
```
基礎FLEE = INT(Lv + 補正後AGI)
```

#### 体装備あり（軽量化）
```
基礎FLEE = INT(30 + Lv × 5/4 + 補正後AGI × 7/4)
```

#### 体装備あり（重量化）
```
基礎FLEE = INT(-15 + Lv/2 + 補正後AGI × 3/4)
```

### 詳細計算

#### 構成要素
- **基礎FLEE**: 体装備の状態とArmorTypeに応じた計算式で算出
- **補正後AGI**: `INT(基礎AGI × (1 + AGI%/100)) + AGI固定値`
- **回避%**: 装備/プロパティ、クリスタ、バフアイテムのDodge_Rate補正の合計
- **回避固定値**: 装備/プロパティ、クリスタ、バフアイテムのDodge補正の合計

**注意点**: 料理からの回避補正は存在しません。

#### 計算例1（体装備なし）
**入力値:**
- レベル: 200
- 補正後AGI: 300
- 回避%: 20% (装備+クリスタ+バフアイテム)
- 回避固定値: 50 (装備+クリスタ+バフアイテム)

**計算手順:**
1. 基礎FLEE = INT(75 + 200 × 3/2 + 300 × 2) = INT(75 + 300 + 600) = INT(975) = 975
2. 回避%適用後 = INT(975 × (1 + 20/100)) = INT(975 × 1.2) = INT(1170) = 1170
3. 最終FLEE = 1170 + 50 = 1220

#### 計算例2（体装備あり・軽量化）
**入力値:**
- レベル: 200
- 補正後AGI: 300
- 回避%: 15% (装備+クリスタ+バフアイテム)
- 回避固定値: 30 (装備+クリスタ+バフアイテム)

**計算手順:**
1. 基礎FLEE = INT(30 + 200 × 5/4 + 300 × 7/4) = INT(30 + 250 + 525) = INT(805) = 805
2. 回避%適用後 = INT(805 × (1 + 15/100)) = INT(805 × 1.15) = INT(925.75) = 925
3. 最終FLEE = 925 + 30 = 955

### TypeScript実装例

```typescript
interface FLEECalculationSteps {
  level: number
  adjustedAGI: number
  baseFLEE: number
  dodgePercent: number
  fleeAfterPercent: number
  dodgeFixed: number
  finalFLEE: number
}

function calculateFLEE(
  level: number,
  adjustedAGI: number,
  hasBodyEquipment: boolean,
  armorType: ArmorType = 'normal',
  allBonuses: AllBonuses = {}
): FLEECalculationSteps {
  // 1. 基礎FLEE計算（体装備状態とArmorTypeに依存）
  let baseFLEE: number
  
  if (!hasBodyEquipment) {
    // 体装備なし
    baseFLEE = Math.floor(75 + level * 3/2 + adjustedAGI * 2)
  } else {
    // 体装備あり
    switch (armorType) {
      case 'light':
        // 軽量化
        baseFLEE = Math.floor(30 + level * 5/4 + adjustedAGI * 7/4)
        break
      case 'heavy':
        // 重量化
        baseFLEE = Math.floor(-15 + level/2 + adjustedAGI * 3/4)
        break
      case 'normal':
      default:
        // 通常
        baseFLEE = Math.floor(level + adjustedAGI)
        break
    }
  }
  
  // 2. 回避%適用
  const dodgePercent = allBonuses.Dodge_Rate || 0
  const fleeAfterPercent = Math.floor(baseFLEE * (1 + dodgePercent / 100))
  
  // 3. 回避固定値加算
  const dodgeFixed = allBonuses.Dodge || 0
  const finalFLEE = fleeAfterPercent + dodgeFixed
  
  return {
    level,
    adjustedAGI,
    baseFLEE,
    dodgePercent,
    fleeAfterPercent,
    dodgeFixed,
    finalFLEE,
  }
}
```

## ASPD（アタックスピード）計算

### 基本計算式
```
ASPD = INT((Lv + ステータスASPD + 武器補正値) × (1 + (ASPD% + ArmorType補正)/100)) + ASPD固定値
```

### ArmorType（防具の改造）補正
体装備の防具の改造による内部ASPD%補正：

| ArmorType | ASPD%補正 |
|-----------|----------|
| 通常 (normal) | +0% |
| 軽量化 (light) | +50% |
| 重量化 (heavy) | -50% |

**重要な注意点:**
- ArmorType補正は内部計算のみで使用され、StatusPreviewの装備品補正値には表示されません
- 最終的なASPD計算にのみ影響し、表示上のASPD%には加算されません

**ArmorType変更時の即座反映:**
- ArmorType変更時に`CalculatorStore.updateEquipmentArmorType`が呼び出される
- データベースレベル更新と同時にZustandストアの状態も強制更新される
- StatusPreviewのASPD計算が自動的に再実行され、新しいArmorType補正が即座に反映される
- 体装備以外のArmorType変更には影響しない（安全性確保）


### ステータスASPD計算

武器種に応じてステータスからASPDを算出：

#### 武器種別ステータスASPD計算式

| 武器種 | 計算式 |
|--------|--------|
| 片手剣 | STR × 0.2 + AGI × 4.2 |
| 両手剣 | STR × 0.2 + AGI × 2.1 |
| 双剣 | STR × 0.2 + AGI × 4.2 |
| 弓 | DEX × 0.2 + AGI × 3.1 |
| 自動弓 | DEX × 0.2 + AGI × 2.2 |
| 杖 | AGI × 1.8 + INT × 0.2 |
| 魔道具 | AGI × 4.0 + INT × 0.2 |
| 手甲 | STR × 0.1 + DEX × 0.1 + AGI × 4.6 |
| 旋風槍 | STR × 0.2 + AGI × 3.5 |
| 抜刀剣 | STR × 0.3 + AGI × 3.9 |
| 素手 | AGI × 9.6 |

### 武器種補正値

各武器種固有の基本ASPD値：

| 武器種 | 補正値 |
|--------|--------|
| 片手剣 | 100 |
| 両手剣 | 50 |
| 双剣 | 100 |
| 弓 | 75 |
| 自動弓 | 30 |
| 杖 | 60 |
| 魔道具 | 900 |
| 手甲 | 120 |
| 旋風槍 | 25 |
| 抜刀剣 | 200 |
| 素手 | 1000 |

### 計算例

#### 例1: 片手剣 + 通常防具
**入力値:**
- Lv: 150
- STR: 200（補正後）
- AGI: 150（補正後）
- 武器種: 片手剣
- ASPD%: 20%
- ASPD固定値: 50
- ArmorType: 通常 (normal)

**計算手順:**
1. ステータスASPD = STR × 0.2 + AGI × 4.2 = 200 × 0.2 + 150 × 4.2 = 40 + 630 = 670
2. 武器補正値 = 100（片手剣）
3. ASPD%適用前 = 150 + 670 + 100 = 920
4. ArmorType補正 = 0%（通常）
5. 実効ASPD% = 20% + 0% = 20%
6. ASPD%適用後 = INT(920 × (1 + 20/100)) = INT(920 × 1.20) = INT(1104) = 1104
7. 最終ASPD = 1104 + 50 = 1154

#### 例2: 片手剣 + 軽量化防具
**入力値:**
- Lv: 150
- STR: 200（補正後）
- AGI: 150（補正後）
- 武器種: 片手剣
- ASPD%: 20%
- ASPD固定値: 50
- ArmorType: 軽量化 (light)

**計算手順:**
1. ステータスASPD = STR × 0.2 + AGI × 4.2 = 200 × 0.2 + 150 × 4.2 = 40 + 630 = 670
2. 武器補正値 = 100（片手剣）
3. ASPD%適用前 = 150 + 670 + 100 = 920
4. ArmorType補正 = +50%（軽量化）
5. 実効ASPD% = 20% + 50% = 70%
6. ASPD%適用後 = INT(920 × (1 + 70/100)) = INT(920 × 1.70) = INT(1564) = 1564
7. 最終ASPD = 1564 + 50 = 1614

#### 例3: 片手剣 + 重量化防具
**入力値:**
- Lv: 150
- STR: 200（補正後）
- AGI: 150（補正後）
- 武器種: 片手剣
- ASPD%: 20%
- ASPD固定値: 50
- ArmorType: 重量化 (heavy)

**計算手順:**
1. ステータスASPD = STR × 0.2 + AGI × 4.2 = 200 × 0.2 + 150 × 4.2 = 40 + 630 = 670
2. 武器補正値 = 100（片手剣）
3. ASPD%適用前 = 150 + 670 + 100 = 920
4. ArmorType補正 = -50%（重量化）
5. 実効ASPD% = 20% + (-50%) = -30%
6. ASPD%適用後 = INT(920 × (1 + (-30)/100)) = INT(920 × 0.70) = INT(644) = 644
7. 最終ASPD = 644 + 50 = 694

### 構成要素

**ASPD%の構成:**
- 装備/プロパティのASPD%補正
- クリスタのASPD%補正
- バフアイテムのASPD%補正
- 料理のASPD%補正

**ASPD固定値の構成:**
- 装備/プロパティのASPD固定値補正
- クリスタのASPD固定値補正
- バフアイテムのASPD固定値補正
- 料理のASPD固定値補正

**ArmorType補正（内部計算のみ）:**
- 体装備の防具の改造設定による内部ASPD%補正
- StatusPreview表示には影響しない
- 通常: 0%、軽量化: +50%、重量化: -50%

## 行動速度（Motion Speed）計算

### 基本計算式
```
行動速度 = MIN(50, MAX(0, INT((ASPD-1000)/180)) + 行動速度%)
```

- `MAX(数値,数値,…)`は各数値の最大値を求める関数
  - 例: MAX(34,26,100) = 100
- `MIN(数値,数値,…)`は各数値の最小値を求める関数
  - 例: MIN(34,26,100) = 26

### 詳細計算

#### 1. ASPDベース行動速度計算
```
ASPDベース行動速度 = INT((ASPD-1000)/180)
```

**説明:**
- ASPDから1000を減算した値を180で除算し、INT()関数で切り捨て
- ASPD 1000未満の場合は負数になる

#### 2. 下限制限適用
```
制限後ベース行動速度 = MAX(0, ASPDベース行動速度)
```

**説明:**
- 0未満の値を0に制限（下限制限）

#### 3. 行動速度%補正適用
```
補正後行動速度 = 制限後ベース行動速度 + 行動速度%
```

**構成要素:**
- **行動速度%**: 装備/プロパティ、クリスタ、バフアイテムの行動速度%(MotionSpeed_Rate)の合計
- **注意**: 料理には行動速度%はありません

#### 4. 上限制限適用
```
最終行動速度 = MIN(50, 補正後行動速度)
```

**説明:**
- 最終的な行動速度は最大50%に制限

### 計算例

#### 例1: 標準的なケース
**入力値:**
- ASPD: 1540
- 行動速度%: 15% (装備+クリスタ+バフアイテム)

**計算手順:**
1. ASPDベース行動速度 = INT((1540-1000)/180) = INT(540/180) = INT(3.0) = 3
2. 制限後ベース行動速度 = MAX(0, 3) = 3
3. 補正後行動速度 = 3 + 15 = 18
4. 最終行動速度 = MIN(50, 18) = 18%

#### 例2: 低ASPDケース
**入力値:**
- ASPD: 800
- 行動速度%: 10%

**計算手順:**
1. ASPDベース行動速度 = INT((800-1000)/180) = INT(-200/180) = INT(-1.11) = -2
2. 制限後ベース行動速度 = MAX(0, -2) = 0
3. 補正後行動速度 = 0 + 10 = 10
4. 最終行動速度 = MIN(50, 10) = 10%

#### 例3: 高ASPDケース
**入力値:**
- ASPD: 2800
- 行動速度%: 30%

**計算手順:**
1. ASPDベース行動速度 = INT((2800-1000)/180) = INT(1800/180) = INT(10.0) = 10
2. 制限後ベース行動速度 = MAX(0, 10) = 10
3. 補正後行動速度 = 10 + 30 = 40
4. 最終行動速度 = MIN(50, 40) = 40%

#### 例4: 上限到達ケース
**入力値:**
- ASPD: 3000
- 行動速度%: 50%

**計算手順:**
1. ASPDベース行動速度 = INT((3000-1000)/180) = INT(2000/180) = INT(11.11) = 11
2. 制限後ベース行動速度 = MAX(0, 11) = 11
3. 補正後行動速度 = 11 + 50 = 61
4. 最終行動速度 = MIN(50, 61) = 50% (上限制限)

### 構成要素

**行動速度%の構成:**
- 装備/プロパティの行動速度%(MotionSpeed_Rate)補正
- クリスタの行動速度%(MotionSpeed_Rate)補正
- バフアイテムの行動速度%(MotionSpeed_Rate)補正
- **除外**: 料理には行動速度%補正はありません

### 重要な制限事項

1. **下限制限**: ASPDベースの行動速度は0%未満にはならない
2. **上限制限**: 最終的な行動速度は50%を超えない
3. **料理除外**: 料理アイテムからの行動速度%補正は存在しない
4. **整数計算**: ASPD計算部分ではINT()関数による切り捨て処理が重要
5. **ArmorType補正**: 防具の改造による補正は内部計算のみで、UI表示のASPD%には反映されない

### HP計算順序（新計算式）
1. **VIT補正計算**: ステータスVIT × (1 + VIT%/100) + VIT固定値
2. **HP基本値計算**: INT(93 + (補正後VIT + 22.41) × Lv / 3)
3. **HP%補正適用**: INT(HP基本値 × (1 + HP%/100))
4. **HP固定値加算**: HP%適用後 + HP固定値

### MP計算順序（新計算式）
1. **補正後INT計算**: INT(基礎INT × (1 + INT%/100)) + INT固定値
2. **MP基本値計算**: INT(Lv + 99 + TEC + 補正後INT/10)
3. **MP%補正適用**: INT(MP基本値 × (1 + MP%/100))
4. **MP固定値加算**: MP%適用後 + MP固定値

### TypeScript実装例
```typescript
interface BasicStatsCalculation {
  calculateHP(stats: BaseStats, allBonuses: AllBonuses): number {
    // 1. 補正後VIT計算
    const vitPercent = allBonuses.VIT_Rate || 0
    const vitFixed = allBonuses.VIT || 0
    const adjustedVIT = stats.VIT * (1 + vitPercent / 100) + vitFixed
    
    // 2. HP基本値計算
    const baseHP = Math.floor(93 + (adjustedVIT + 22.41) * stats.level / 3)
    
    // 3. HP%補正適用
    const hpPercent = allBonuses.HP_Rate || 0
    const hpAfterPercent = Math.floor(baseHP * (1 + hpPercent / 100))
    
    // 4. HP固定値加算
    const hpFixed = allBonuses.HP || 0
    
    // 5. 最終HP
    return hpAfterPercent + hpFixed
  }

  calculateMP(stats: BaseStats, allBonuses: AllBonuses): number {
    // 1. 補正後INT計算
    const intPercent = allBonuses.INT_Rate || 0
    const intFixed = allBonuses.INT || 0
    const adjustedINT = Math.floor(stats.INT * (1 + intPercent / 100)) + intFixed
    
    // 2. MP基本値計算
    const baseMP = Math.floor(stats.level + 99 + stats.TEC + adjustedINT / 10)
    
    // 3. MP%補正適用
    const mpPercent = allBonuses.MP_Rate || 0
    const mpAfterPercent = Math.floor(baseMP * (1 + mpPercent / 100))
    
    // 4. MP固定値加算
    const mpFixed = allBonuses.MP || 0
    
    // 5. 最終MP
    return mpAfterPercent + mpFixed
  }

  calculateMotionSpeed(aspd: number, allBonuses: AllBonuses): number {
    // 1. ASPDベース行動速度計算
    const aspdBase = Math.floor((aspd - 1000) / 180)
    
    // 2. 下限制限適用（0未満を0に制限）
    const aspdBaseClamped = Math.max(0, aspdBase)
    
    // 3. 行動速度%補正適用
    const motionSpeedPercent = allBonuses.MotionSpeed_Rate || 0
    const motionSpeedAfterPercent = aspdBaseClamped + motionSpeedPercent
    
    // 4. 上限制限適用（50%上限）
    const finalMotionSpeed = Math.min(50, motionSpeedAfterPercent)
    
    return finalMotionSpeed
  }

  calculateASPD(
    level: number,
    stats: BaseStats,
    weaponType: WeaponType,
    allBonuses: AllBonuses,
    armorType: ArmorType = 'normal'
  ): number {
    // 1. ステータスASPD計算（武器種別）
    const statusASPD = this.calculateStatusASPD(stats, weaponType)
    
    // 2. 武器補正値取得
    const weaponBaseASPD = this.getWeaponBaseASPD(weaponType)
    
    // 3. ASPD%計算（装備+クリスタ+バフアイテム+料理）
    const aspdPercent = allBonuses.AttackSpeed_Rate || 0
    
    // 4. ArmorType補正計算（内部計算のみ）
    const armorTypeBonus = this.getArmorTypeASPDBonus(armorType)
    
    // 5. 実効ASPD%計算
    const effectiveASPDPercent = aspdPercent + armorTypeBonus
    
    // 6. ASPD基本値計算
    const aspdBase = level + statusASPD + weaponBaseASPD
    
    // 7. ASPD%適用
    const aspdAfterPercent = Math.floor(aspdBase * (1 + effectiveASPDPercent / 100))
    
    // 8. ASPD固定値加算
    const aspdFixed = allBonuses.AttackSpeed || 0
    
    return aspdAfterPercent + aspdFixed
  }

  private getArmorTypeASPDBonus(armorType: ArmorType): number {
    switch (armorType) {
      case 'light': return 50   // 軽量化: +50%
      case 'heavy': return -50  // 重量化: -50%
      case 'normal':
      default: return 0         // 通常: +0%
    }
  }
}

// AllBonusesはequipment, crystal, food, buffの全補正値をまとめたもの
interface AllBonuses {
  VIT?: number            // VIT固定値の合計
  VIT_Rate?: number       // VIT%の合計
  INT?: number            // INT固定値の合計
  INT_Rate?: number       // INT%の合計
  HP?: number             // HP固定値の合計
  HP_Rate?: number        // HP%の合計
  MP?: number             // MP固定値の合計
  MP_Rate?: number        // MP%の合計
  AttackSpeed?: number    // ASPD固定値の合計
  AttackSpeed_Rate?: number // ASPD%の合計
  MotionSpeed_Rate?: number  // 行動速度%の合計（装備+クリスタ+バフアイテム、料理除外）
  // その他のステータス...
}

type ArmorType = 'normal' | 'light' | 'heavy'
```

## 検証データ

### HP計算検証例（新計算式）
| VIT | Lv | VIT% | VIT固定 | HP% | HP固定 | 期待HP | 実測HP | 状態 |
|-----|----|----- |---------|-----|--------|--------|--------|------|
| 100 | 100 | 0% | 0 | 0% | 0 | 4776 | - | 🔄 |
| 200 | 150 | 15% | 30 | 25% | 200 | 17966 | - | 🔄 |
| 300 | 200 | 20% | 50 | 30% | 300 | 33614 | - | 🔄 |

**計算詳細例（VIT:200, Lv:150）:**
1. 補正後VIT = 200 × 1.15 + 30 = 260
2. HP基本値 = INT(93 + (260 + 22.41) × 150 / 3) = 14213
3. HP%適用後 = INT(14213 × 1.25) = 17766
4. 最終HP = 17766 + 200 = 17966

### MP計算検証例（新計算式）
| Lv | TEC | 基礎INT | INT% | INT固定 | MP% | MP固定 | 期待MP | 実測MP | 状態 |
|----|-----|---------|------|---------|-----|--------|--------|--------|------|
| 100 | 50 | 100 | 0% | 0 | 0% | 0 | 259 | - | 🔄 |
| 150 | 80 | 200 | 10% | 20 | 30% | 100 | 558 | - | 🔄 |
| 200 | 100 | 300 | 15% | 30 | 40% | 150 | 722 | - | 🔄 |

**計算詳細例（Lv:150, TEC:80, 基礎INT:200）:**
1. 補正後INT = INT(200 × 1.10) + 20 = 240
2. MP基本値 = INT(150 + 99 + 80 + 240/10) = 353
3. MP%適用後 = INT(353 × 1.30) = 458
4. 最終MP = 458 + 100 = 558

### ASPD計算検証例
| Lv | STR | AGI | 武器種 | ASPD% | ASPD固定 | ArmorType | 期待ASPD | 実測ASPD | 状態 |
|----|-----|-----|--------|-------|----------|-----------|----------|----------|------|
| 150 | 200 | 150 | 片手剣 | 20% | 50 | 通常 | 1154 | - | 🔄 |
| 150 | 200 | 150 | 片手剣 | 20% | 50 | 軽量化 | 1614 | - | 🔄 |
| 150 | 200 | 150 | 片手剣 | 20% | 50 | 重量化 | 694 | - | 🔄 |

**ASPD計算詳細例（Lv:150, STR:200, AGI:150, 片手剣, 軽量化）:**
1. ステータスASPD = 200 × 0.2 + 150 × 4.2 = 670
2. 武器補正値 = 100（片手剣）
3. ASPD基本値 = 150 + 670 + 100 = 920
4. 実効ASPD% = 20% + 50%（軽量化） = 70%
5. ASPD%適用後 = INT(920 × 1.70) = 1564
6. 最終ASPD = 1564 + 50 = 1614

## クリティカル率計算

### 基本計算式
```
クリティカル率(%) = INT(INT(25+CRT/3.4)×(1+クリティカル率%/100))+クリティカル率固定値
```


### 詳細計算

#### 1. CRT基礎クリティカル率計算
```
CRT基礎クリティカル率 = INT(25 + CRT/3.4)
```

**構成要素:**
- **CRT**: ステータスのCRT（基本値、装備補正なし）
- **基本値25**: 全キャラクター共通のベースクリティカル率

#### 2. クリティカル率%補正適用
```
クリティカル率%適用後 = INT(CRT基礎クリティカル率 × (1 + クリティカル率%/100))
```

**構成要素:**
- **クリティカル率%**: 装備/プロパティ、クリスタ、バフアイテムのクリティカル率%(Critical_Rate)の合計
- **除外**: 料理にはクリティカル率%補正はありません

#### 3. クリティカル率固定値加算
```
最終クリティカル率 = クリティカル率%適用後 + クリティカル率固定値
```

**構成要素:**
- **クリティカル率固定値**: 装備/プロパティ、クリスタ、料理（たこ焼き）、バフアイテムのクリティカル率固定値(Critical)の合計

### 計算例

#### 例1: 標準的なケース
**入力値:**
- CRT: 100
- クリティカル率%: 20% (装備+クリスタ+バフアイテム)
- クリティカル率固定値: 15 (装備+クリスタ+料理+バフアイテム)

**計算手順:**
1. CRT基礎クリティカル率 = INT(25 + 100/3.4) = INT(25 + 29.41) = INT(54.41) = 54
2. クリティカル率%適用後 = INT(54 × (1 + 20/100)) = INT(54 × 1.20) = INT(64.8) = 64
3. 最終クリティカル率 = 64 + 15 = 79%

#### 例2: 高CRTケース
**入力値:**
- CRT: 200
- クリティカル率%: 35%
- クリティカル率固定値: 25

**計算手順:**
1. CRT基礎クリティカル率 = INT(25 + 200/3.4) = INT(25 + 58.82) = INT(83.82) = 83
2. クリティカル率%適用後 = INT(83 × (1 + 35/100)) = INT(83 × 1.35) = INT(112.05) = 112
3. 最終クリティカル率 = 112 + 25 = 137%

#### 例3: 低CRTケース
**入力値:**
- CRT: 50
- クリティカル率%: 10%
- クリティカル率固定値: 5

**計算手順:**
1. CRT基礎クリティカル率 = INT(25 + 50/3.4) = INT(25 + 14.71) = INT(39.71) = 39
2. クリティカル率%適用後 = INT(39 × (1 + 10/100)) = INT(39 × 1.10) = INT(42.9) = 42
3. 最終クリティカル率 = 42 + 5 = 47%

### 構成要素

**クリティカル率%の構成:**
- 装備/プロパティのクリティカル率%(Critical_Rate)補正
- クリスタのクリティカル率%(Critical_Rate)補正
- バフアイテムのクリティカル率%(Critical_Rate)補正
- **除外**: 料理にはクリティカル率%補正はありません

**クリティカル率固定値の構成:**
- 装備/プロパティのクリティカル率固定値(Critical)補正
- クリスタのクリティカル率固定値(Critical)補正
- 料理のクリティカル率固定値(Critical)補正（例：たこ焼き）
- バフアイテムのクリティカル率固定値(Critical)補正

### 重要な制限事項

1. **整数計算**: 2段階のINT()関数による切り捨て処理が重要
2. **料理の特殊性**: 料理にはクリティカル率%補正はないが、クリティカル率固定値補正は存在する

## HIT（命中）計算

### 基本計算式
```
HIT = INT((Lv+総DEX)×(1+命中%/100))+命中固定値
```

### 詳細計算

#### 構成要素
- **Lv**: ステータスのレベル
- **総DEX**: 補正後ステータスのDEX（装備・クリスタ・バフアイテム・料理補正を含む）
- **命中%**: 装備/プロパティ、クリスタ、バフアイテムの命中%(Accuracy_Rate)の合計
- **命中固定値**: 装備/プロパティ、クリスタ、料理（しょうゆラーメン）、バフアイテムの命中固定値(Accuracy)の合計

#### 計算手順
1. **総DEX取得**: 補正後ステータスのDEX値を使用
2. **レベル加算**: Lv + 総DEX
3. **命中%適用**: INT((Lv + 総DEX) × (1 + 命中%/100))
4. **命中固定値加算**: %適用後 + 命中固定値

### 計算例

#### 例1: 標準的なケース
**入力値:**
- Lv: 150
- 総DEX: 250 (補正後ステータス)
- 命中%: 20% (装備+クリスタ+バフアイテム)
- 命中固定値: 30 (装備+クリスタ+料理+バフアイテム)

**計算手順:**
1. Lv + 総DEX = 150 + 250 = 400
2. 命中%適用後 = INT(400 × (1 + 20/100)) = INT(400 × 1.20) = INT(480) = 480
3. 最終HIT = 480 + 30 = 510

#### 例2: 高DEXケース
**入力値:**
- Lv: 200
- 総DEX: 350
- 命中%: 35%
- 命中固定値: 50

**計算手順:**
1. Lv + 総DEX = 200 + 350 = 550
2. 命中%適用後 = INT(550 × (1 + 35/100)) = INT(550 × 1.35) = INT(742.5) = 742
3. 最終HIT = 742 + 50 = 792

#### 例3: 低DEXケース
**入力値:**
- Lv: 100
- 総DEX: 150
- 命中%: 10%
- 命中固定値: 15

**計算手順:**
1. Lv + 総DEX = 100 + 150 = 250
2. 命中%適用後 = INT(250 × (1 + 10/100)) = INT(250 × 1.10) = INT(275) = 275
3. 最終HIT = 275 + 15 = 290

### 構成要素

**命中%の構成:**
- 装備/プロパティの命中%(Accuracy_Rate)補正
- クリスタの命中%(Accuracy_Rate)補正
- バフアイテムの命中%(Accuracy_Rate)補正
- **除外**: 料理には命中%補正はありません

**命中固定値の構成:**
- 装備/プロパティの命中固定値(Accuracy)補正
- クリスタの命中固定値(Accuracy)補正
- 料理の命中固定値(Accuracy)補正（例：しょうゆラーメン）
- バフアイテムの命中固定値(Accuracy)補正

### 重要な制限事項

1. **補正後DEX使用**: 基礎DEXではなく、全補正を適用した補正後ステータスのDEXを使用
2. **料理の特殊性**: 料理には命中%補正はないが、命中固定値補正は存在する
3. **整数計算**: INT()関数による切り捨て処理が重要

## 総属性有利（Total Element Advantage）計算

### 基本計算式
```
総属性有利(%) = 装備/プロパティ属性有利% + クリスタ属性有利% + 料理属性有利% + バフアイテム属性有利%
```

### 詳細計算

#### 構成要素
- **装備/プロパティ属性有利%**: 装備品のプロパティからの属性有利%(ElementAdvantage_Rate)補正
- **クリスタ属性有利%**: セットしてあるクリスタからの属性有利%(ElementAdvantage_Rate)補正
- **料理属性有利%**: 料理からの属性有利%(ElementAdvantage_Rate)補正（例：属性パスタ（有利共通））
- **バフアイテム属性有利%**: バフアイテムからの属性有利%(ElementAdvantage_Rate)補正

#### 計算手順
1. **各ソースから属性有利%を取得**
2. **単純合算**: 全ての属性有利%補正を加算

### 計算例

#### 例1: 標準的なケース
**入力値:**
- 装備/プロパティ属性有利%: 15%
- クリスタ属性有利%: 10%
- 料理属性有利%: 12% (属性パスタLv8)
- バフアイテム属性有利%: 8%

**計算手順:**
1. 最終総属性有利 = 15% + 10% + 12% + 8% = 45%

#### 例2: 料理なしケース
**入力値:**
- 装備/プロパティ属性有利%: 20%
- クリスタ属性有利%: 15%
- 料理属性有利%: 0% (なし)
- バフアイテム属性有利%: 5%

**計算手順:**
1. 最終総属性有利 = 20% + 15% + 0% + 5% = 40%

#### 例3: 高数値ケース（属性特化ビルド）
**入力値:**
- 装備/プロパティ属性有利%: 35%
- クリスタ属性有利%: 25%
- 料理属性有利%: 15% (属性パスタLv10)
- バフアイテム属性有利%: 12%

**計算手順:**
1. 最終総属性有利 = 35% + 25% + 15% + 12% = 87%

### 構成要素

**属性有利%の構成:**
- 装備/プロパティの属性有利%(ElementAdvantage_Rate)補正
- クリスタの属性有利%(ElementAdvantage_Rate)補正
- 料理の属性有利%(ElementAdvantage_Rate)補正（例：属性パスタ（有利共通））
- バフアイテムの属性有利%(ElementAdvantage_Rate)補正

### 重要な制限事項

1. **%補正のみ**: 属性有利は%補正のみで、固定値補正は存在しない
2. **単純加算**: 複雑な計算式は不要で、各ソースからの%値を直接加算
3. **全属性共通**: 特定の属性に限定されず、全ての属性攻撃に適用される
4. **基本ステータス項目**: StatusPreviewの基本ステータス30項目の1つとして表示される

## 物理耐性計算

### 基本計算式
```
物理耐性(%) = 装備/プロパティ物理耐性% + クリスタ物理耐性% + 料理物理耐性% + バフアイテム物理耐性%
```

### 詳細計算

#### 構成要素
- **装備/プロパティ物理耐性%**: 装備品のプロパティからの物理耐性%(PhysicalResistance_Rate)補正
- **クリスタ物理耐性%**: セットしてあるクリスタからの物理耐性%(PhysicalResistance_Rate)補正
- **料理物理耐性%**: 料理からの物理耐性%(PhysicalResistance_Rate)補正（例：ビーフバーガー（物理耐性））
- **バフアイテム物理耐性%**: バフアイテムからの物理耐性%(PhysicalResistance_Rate)補正

#### 計算手順
1. **各ソースから物理耐性%を取得**
2. **単純合算**: 全ての物理耐性%補正を加算

### 計算例

#### 例1: 標準的なケース
**入力値:**
- 装備/プロパティ物理耐性%: 15%
- クリスタ物理耐性%: 10%
- 料理物理耐性%: 8% (ビーフバーガーLv4)
- バフアイテム物理耐性%: 5%

**計算手順:**
1. 最終物理耐性 = 15% + 10% + 8% + 5% = 38%

#### 例2: 料理なしケース
**入力値:**
- 装備/プロパティ物理耐性%: 20%
- クリスタ物理耐性%: 12%
- 料理物理耐性%: 0% (なし)
- バフアイテム物理耐性%: 8%

**計算手順:**
1. 最終物理耐性 = 20% + 12% + 0% + 8% = 40%

### 構成要素

**物理耐性%の構成:**
- 装備/プロパティの物理耐性%(PhysicalResistance_Rate)補正
- クリスタの物理耐性%(PhysicalResistance_Rate)補正
- 料理の物理耐性%(PhysicalResistance_Rate)補正（例：ビーフバーガー）
- バフアイテムの物理耐性%(PhysicalResistance_Rate)補正

### 重要な制限事項

1. **%補正のみ**: 物理耐性は%補正のみで、固定値補正は存在しない
2. **単純合算**: 複雑な計算はなく、全ての%補正を単純に加算
3. **料理対応**: 料理（ビーフバーガー）からも物理耐性%補正が得られる

## 魔法耐性計算

### 基本計算式
```
魔法耐性(%) = 装備/プロパティ魔法耐性% + クリスタ魔法耐性% + 料理魔法耐性% + バフアイテム魔法耐性%
```

### 詳細計算

#### 構成要素
- **装備/プロパティ魔法耐性%**: 装備品のプロパティからの魔法耐性%(MagicalResistance_Rate)補正
- **クリスタ魔法耐性%**: セットしてあるクリスタからの魔法耐性%(MagicalResistance_Rate)補正
- **料理魔法耐性%**: 料理からの魔法耐性%(MagicalResistance_Rate)補正（例：フィッシュバーガー（魔法耐性））
- **バフアイテム魔法耐性%**: バフアイテムからの魔法耐性%(MagicalResistance_Rate)補正

#### 計算手順
1. **各ソースから魔法耐性%を取得**
2. **単純合算**: 全ての魔法耐性%補正を加算

### 計算例

#### 例1: 標準的なケース
**入力値:**
- 装備/プロパティ魔法耐性%: 12%
- クリスタ魔法耐性%: 8%
- 料理魔法耐性%: 6% (フィッシュバーガーLv3)
- バフアイテム魔法耐性%: 4%

**計算手順:**
1. 最終魔法耐性 = 12% + 8% + 6% + 4% = 30%

#### 例2: 料理なしケース
**入力値:**
- 装備/プロパティ魔法耐性%: 18%
- クリスタ魔法耐性%: 10%
- 料理魔法耐性%: 0% (なし)
- バフアイテム魔法耐性%: 7%

**計算手順:**
1. 最終魔法耐性 = 18% + 10% + 0% + 7% = 35%

### 構成要素

**魔法耐性%の構成:**
- 装備/プロパティの魔法耐性%(MagicalResistance_Rate)補正
- クリスタの魔法耐性%(MagicalResistance_Rate)補正
- 料理の魔法耐性%(MagicalResistance_Rate)補正（例：フィッシュバーガー）
- バフアイテムの魔法耐性%(MagicalResistance_Rate)補正

### 重要な制限事項

1. **%補正のみ**: 魔法耐性は%補正のみで、固定値補正は存在しない
2. **単純合算**: 複雑な計算はなく、全ての%補正を単純に加算
3. **料理対応**: 料理（フィッシュバーガー）からも魔法耐性%補正が得られる

## 防御崩し計算

### 基本計算式
```
防御崩し(%) = 装備/プロパティ防御崩し% + クリスタ防御崩し% + バフアイテム防御崩し%
```

### 詳細計算

#### 構成要素
- **装備/プロパティ防御崩し%**: 装備品のプロパティからの防御崩し%(ArmorBreak_Rate)補正
- **クリスタ防御崩し%**: セットしてあるクリスタからの防御崩し%(ArmorBreak_Rate)補正
- **バフアイテム防御崩し%**: バフアイテムからの防御崩し%(ArmorBreak_Rate)補正

#### 計算手順
1. **各ソースから防御崩し%を取得**
2. **単純合算**: 全ての防御崩し%補正を加算

### 計算例

#### 例1: 標準的なケース
**入力値:**
- 装備/プロパティ防御崩し%: 8%
- クリスタ防御崩し%: 5%
- バフアイテム防御崩し%: 3%

**計算手順:**
1. 最終防御崩し = 8% + 5% + 3% = 16%

#### 例2: バフアイテムなしケース
**入力値:**
- 装備/プロパティ防御崩し%: 12%
- クリスタ防御崩し%: 6%
- バフアイテム防御崩し%: 0% (なし)

**計算手順:**
1. 最終防御崩し = 12% + 6% + 0% = 18%

### 構成要素

**防御崩し%の構成:**
- 装備/プロパティの防御崩し%(ArmorBreak_Rate)補正
- クリスタの防御崩し%(ArmorBreak_Rate)補正
- バフアイテムの防御崩し%(ArmorBreak_Rate)補正

### 重要な制限事項

1. **%補正のみ**: 防御崩しは%補正のみで、固定値補正は存在しない
2. **単純合算**: 複雑な計算はなく、全ての%補正を単純に加算
3. **料理除外**: 料理からの防御崩し%補正は存在しない

## 先読み計算

### 基本計算式
```
先読み(%) = 装備/プロパティ先読み% + クリスタ先読み% + バフアイテム先読み%
```

### 詳細計算

#### 構成要素
- **装備/プロパティ先読み%**: 装備品のプロパティからの先読み%(Anticipate)補正
- **クリスタ先読み%**: セットしてあるクリスタからの先読み%(Anticipate)補正
- **バフアイテム先読み%**: バフアイテムからの先読み%(Anticipate)補正

#### 計算手順
1. **各ソースから先読み%を取得**
2. **単純合算**: 全ての先読み%補正を加算

### 計算例

#### 例1: 標準的なケース
**入力値:**
- 装備/プロパティ先読み%: 6%
- クリスタ先読み%: 4%
- バフアイテム先読み%: 2%

**計算手順:**
1. 最終先読み = 6% + 4% + 2% = 12%

#### 例2: クリスタなしケース
**入力値:**
- 装備/プロパティ先読み%: 10%
- クリスタ先読み%: 0% (なし)
- バフアイテム先読み%: 3%

**計算手順:**
1. 最終先読み = 10% + 0% + 3% = 13%

### 構成要素

**先読み%の構成:**
- 装備/プロパティの先読み%(Anticipate)補正
- クリスタの先読み%(Anticipate)補正
- バフアイテムの先読み%(Anticipate)補正

### 重要な制限事項

1. **%補正のみ**: 先読みは%補正のみで、固定値補正は存在しない
2. **単純合算**: 複雑な計算はなく、全ての%補正を単純に加算
3. **料理除外**: 料理からの先読み%補正は存在しない

## CSPD（詠唱速度）計算

### 基本計算式
```
CSPD = INT((INT(Lv+補正後DEX×2.94+補正後AGI×1.16))×(1+CSPD%/100))+CSPD固定値
```

### 詳細計算

#### 1. ベースCSPD計算
```
ベースCSPD = INT(Lv + 補正後DEX × 2.94 + 補正後AGI × 1.16)
```

**構成要素:**
- **Lv**: キャラクターレベル
- **補正後DEX**: 補正後ステータスのDEX（装備・クリスタ・バフアイテム・料理補正を含む）
- **補正後AGI**: 補正後ステータスのAGI（装備・クリスタ・バフアイテム・料理補正を含む）

#### 2. CSPD%補正適用
```
CSPD%適用後 = INT(ベースCSPD × (1 + CSPD%/100))
```

**構成要素:**
- **CSPD%**: 装備/プロパティ、クリスタ、バフアイテムのCSPD%(CastingSpeed_Rate)補正の合計

#### 3. CSPD固定値加算
```
最終CSPD = CSPD%適用後 + CSPD固定値
```

**構成要素:**
- **CSPD固定値**: 装備/プロパティ、クリスタ、バフアイテムのCSPD固定値(CastingSpeed)補正の合計

### 計算例

#### 例1: 標準的なケース
**入力値:**
- レベル: 200
- 補正後DEX: 180
- 補正後AGI: 150
- CSPD%: 25% (装備+クリスタ+バフアイテム)
- CSPD固定値: 100 (装備+クリスタ+バフアイテム)

**計算手順:**
1. ベースCSPD = INT(200 + 180 × 2.94 + 150 × 1.16) = INT(200 + 529.2 + 174) = INT(903.2) = 903
2. CSPD%適用後 = INT(903 × (1 + 25/100)) = INT(903 × 1.25) = INT(1128.75) = 1128
3. 最終CSPD = 1128 + 100 = 1228

#### 例2: 高AGI・DEXケース
**入力値:**
- レベル: 250
- 補正後DEX: 220
- 補正後AGI: 200
- CSPD%: 40%
- CSPD固定値: 150

**計算手順:**
1. ベースCSPD = INT(250 + 220 × 2.94 + 200 × 1.16) = INT(250 + 646.8 + 232) = INT(1128.8) = 1128
2. CSPD%適用後 = INT(1128 × (1 + 40/100)) = INT(1128 × 1.40) = INT(1579.2) = 1579
3. 最終CSPD = 1579 + 150 = 1729

### 構成要素

**CSPD%の構成:**
- 装備/プロパティのCSPD%(CastingSpeed_Rate)補正
- クリスタのCSPD%(CastingSpeed_Rate)補正
- バフアイテムのCSPD%(CastingSpeed_Rate)補正

**CSPD固定値の構成:**
- 装備/プロパティのCSPD固定値(CastingSpeed)補正
- クリスタのCSPD固定値(CastingSpeed)補正
- バフアイテムのCSPD固定値(CastingSpeed)補正

### 重要な制限事項

1. **補正後ステータス使用**: 基礎DEX・AGIではなく、全補正を適用した補正後ステータスを使用
2. **料理除外**: 料理からのCSPD%・CSPD固定値補正は存在しない
3. **整数計算**: INT()関数による切り捨て処理が2段階で重要
4. **DEX重要度**: DEX × 2.94 でAGI × 1.16 よりもDEXの影響が大きい

**凡例:**
- ✅: 検証済み（正確）
- 🔄: 検証待ち
- ❌: 要修正


## 安定率（Stability Rate）計算

### 基本計算式
```
安定率(%) = INT(MAX(0, MIN(100, メイン武器の安定率 + ステータス安定率 + 安定率%)))
```

**重要**: 最終結果はINT()関数（小数点以下切り捨て）が適用されます。

### 詳細計算

#### 構成要素
- **メイン武器の安定率**: メイン武器固有の安定率値
- **ステータス安定率**: 武器種別に応じたSTR・DEXによる計算値
- **安定率%**: 補正後安定率(パーセント) = 装備/プロパティ + クリスタ + バフアイテムの安定率%の合計

#### ステータス安定率の武器種別計算式
- **片手剣**: STR × 0.025 + DEX × 0.075
- **両手剣**: DEX × 0.1
- **弓**: STR × 0.05 + DEX × 0.05
- **自動弓**: STR × 0.05
- **杖**: STR × 0.05
- **魔道具**: DEX × 0.1
- **手甲**: DEX × 0.025
- **旋風槍**: STR × 0.05 + DEX × 0.05
- **抜刀剣**: STR × 0.075 + DEX × 0.025
- **素手**: DEX × 0.35
- **双剣**: 特殊計算（保留）

#### 計算手順
1. **ステータス安定率計算**: 武器種別に応じたSTR・DEX係数による計算
2. **各要素の合算**: メイン武器安定率 + ステータス安定率 + 安定率%
3. **上限制限**: MIN(100, 合算値) で100%上限を適用
4. **下限制限**: MAX(0, 上限制限後値) で0%下限を適用
5. **小数点切り捨て**: INT()関数で最終結果の小数点以下を切り捨て

### 計算例

#### 例1: 片手剣の場合
**入力値:**
- メイン武器の安定率: 75%
- STR: 200, DEX: 150
- 安定率%: 8% (装備/プロパティ5% + クリスタ2% + バフアイテム1%)

**計算手順:**
1. ステータス安定率 = 200 × 0.025 + 150 × 0.075 = 5 + 11.25 = 16.25
2. 合算値 = 75 + 16.25 + 8 = 99.25%
3. 上限制限 = MIN(100, 99.25) = 99.25%
4. 下限制限 = MAX(0, 99.25) = 99.25%
5. 小数点切り捨て = INT(99.25) = 99
6. **最終安定率 = 99%**

#### 例2: 素手・高DEXの場合
**入力値:**
- メイン武器の安定率: 50%
- STR: 100, DEX: 400
- 安定率%: 15%

**計算手順:**
1. ステータス安定率 = 400 × 0.35 = 140
2. 合算値 = 50 + 140 + 15 = 205%
3. 上限制限 = MIN(100, 205) = 100%
4. 下限制限 = MAX(0, 100) = 100%
5. 小数点切り捨て = INT(100) = 100
6. **最終安定率 = 100%**

#### 例3: 魔道具の場合
**入力値:**
- メイン武器の安定率: 65%
- STR: 50, DEX: 250
- 安定率%: 5%

**計算手順:**
1. ステータス安定率 = 250 × 0.1 = 25
2. 合算値 = 65 + 25 + 5 = 95%
3. 上限制限 = MIN(100, 95) = 95%
4. 下限制限 = MAX(0, 95) = 95%
5. 小数点切り捨て = INT(95) = 95
6. **最終安定率 = 95%**

#### 例4: 旋風槍の場合
**入力値:**
- メイン武器の安定率: 60%
- STR: 510, DEX: 1
- 安定率%: 0% (補正なし)

**計算手順:**
1. ステータス安定率 = 510 × 0.05 + 1 × 0.05 = 25.5 + 0.05 = 25.55
2. 合算値 = 60 + 25.55 + 0 = 85.55%
3. 上限制限 = MIN(100, 85.55) = 85.55%
4. 下限制限 = MAX(0, 85.55) = 85.55%
5. 小数点切り捨て = INT(85.55) = 85
6. **最終安定率 = 85%**

### 構成要素

**安定率%（パーセント）の構成:**
- 装備/プロパティの安定率%(Stability_Rate)補正
- クリスタの安定率%(Stability_Rate)補正
- バフアイテムの安定率%(Stability_Rate)補正

### 重要な制限事項

1. **上限・下限制限**: 0%～100%の範囲で制限される
2. **MIN/MAX関数**: 上限・下限制限にMIN/MAX関数を使用
3. **小数点切り捨て**: 最終結果にINT()関数を適用して小数点以下を切り捨て
4. **料理除外**: 料理からの安定率補正は存在しない
5. **武器種依存**: ステータス安定率は武器種別により計算式が大きく異なる
6. **双剣特殊**: 双剣の安定率計算は特殊なため保留

## 更新履歴

| 日付 | 更新内容 | 備考 |
|------|----------|------|
| 2024-06-23 | HP・MP計算式の初期作成 | 基本的な計算式を記述 |
| 2024-06-23 | HP計算式を正確な式に修正 | INT()関数使用、補正後VIT導入、2段階計算に変更 |
| 2024-06-23 | MP計算式を正確な式に修正 | INT()関数使用、TECとINT活用、2段階計算に変更 |
| 2024-06-25 | 行動速度計算式を追加 | MIN/MAX/INT関数使用、ASPD依存、50%上限制限 |
| 2024-06-25 | クリティカル率計算式を追加 | INT()関数使用、CRT依存、2段階計算、料理固定値対応 |
| 2024-06-25 | HIT（命中）計算式を追加 | INT()関数使用、Lv+補正後DEX依存、料理固定値対応 |
| 2025-06-28 | ASPD計算式にArmorType補正を追加 | 軽量化+50%、重量化-50%、内部計算のみでUI表示に影響しない |
| 2025-06-28 | FLEE（回避率）計算式を追加 | 体装備状態とArmorType依存、4種類の基礎FLEE計算式、INT関数使用、2段階計算、料理除外 |
| 2024-06-26 | 物理耐性計算式を追加 | 4データソース統合、単純加算方式、料理対応 |
| 2024-06-26 | 魔法耐性計算式を追加 | 4データソース統合、単純加算方式、フィッシュバーガー対応 |
| 2024-06-26 | 防御崩し計算式を追加 | 3データソース統合、単純加算方式、料理除外 |
| 2024-06-26 | 先読み計算式を追加 | 3データソース統合、単純加算方式、料理除外 |
| 2024-06-26 | CSPD（詠唱速度）計算式を追加 | INT関数使用、Lv+補正後DEX・AGI依存、2段階計算、料理除外 |
| 2024-06-26 | 総属性有利計算式を追加 | 4データソース統合、単純加算方式、属性パスタ対応 |
| 2024-06-27 | 総属性有利計算を基本ステータス項目として再配置 | HIT計算の後に移動、基本ステータス30項目の1つとして明確化 |
| 2024-06-27 | 安定率計算式を追加 | MIN/MAX/INT関数使用、0-100%制限、武器種別ステータス安定率+3データソース統合、小数点切り捨て |

## 関連ドキュメント
- [計算式概要](./overview.md)
- [装備品補正値計算](./equipment-bonuses.md)
- [クリスタ効果計算](./crystal-effects.md)