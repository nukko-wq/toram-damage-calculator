# 基本ステータス計算式

## 概要
キャラクターの基本的な生存力を表すHPとMPの計算式と、補正後基本ステータス（STR/INT/VIT/AGI/DEX）の計算式について記述する。

## 補正後基本ステータス計算

### STR（筋力）
```
補正後STR = INT(基礎STR × (1 + STR%/100)) + STR固定値
```

### INT（知力）
```
補正後INT = INT(基礎INT × (1 + INT%/100)) + INT固定値
```

### VIT（体力）
```
補正後VIT = INT(基礎VIT × (1 + VIT%/100)) + VIT固定値
```

### AGI（敏捷）
```
補正後AGI = INT(基礎AGI × (1 + AGI%/100)) + AGI固定値
```

### DEX（器用）
```
補正後DEX = INT(基礎DEX × (1 + DEX%/100)) + DEX固定値
```

**注意:** `INT(数値)`は小数点以下を元の数値より小さい整数に切り捨てる関数
- 例: INT(-2.7) = -3
- ※ステータスのINTと混同しないように注意

### 計算例（STR）
**入力値:**
- 基礎STR: 200
- STR%: 15% (装備+クリスタ+バフアイテム)
- STR固定値: 30 (装備+クリスタ+バフアイテム)

**計算手順:**
1. 基礎STR × (1 + STR%/100) = 200 × (1 + 15/100) = 200 × 1.15 = 230
2. INT(230) = 230
3. 補正後STR = 230 + 30 = 260

### 構成要素
**%補正値の構成:**
- 装備/プロパティのステータス%補正
- セットしてあるクリスタのステータス%補正
- バフアイテムのステータス%補正
- 料理のステータス%補正

**固定値の構成:**
- 装備/プロパティのステータス固定値補正
- セットしてあるクリスタのステータス固定値補正
- バフアイテムのステータス固定値補正
- 料理のステータス固定値補正

## HP（ヒットポイント）計算

### 基本計算式
```
HP = INT(INT(93+(補正後VIT+22.41)*Lv/3)*(1+HP%/100))+HP固定値
```

**注意:** `INT(数値)`は小数点以下を切り捨てる関数（ステータスのINTとは異なる）
- 例: INT(-2.7) = -3

### 詳細計算

#### 1. 補正後VIT計算
```
補正後VIT = ステータスのVIT × (1 + VIT%/100) + VIT固定値
```

**構成要素:**
- **VIT%**: 装備/プロパティとセットしてあるクリスタ、バフアイテムのVIT%の合計
- **VIT固定値**: 装備/プロパティとセットしてあるクリスタ、バフアイテムのVIT固定値の合計

**計算例:**
- ステータスのVIT: 200
- VIT%: 15% (装備+クリスタ)
- VIT固定値: 30 (装備+クリスタ)
- 補正後VIT = 200 × (1 + 15/100) + 30 = 200 × 1.15 + 30 = 230 + 30 = 260

#### 2. HP基本値計算
```
HP基本値 = INT(93 + (補正後VIT + 22.41) × Lv / 3)
```

**計算例:**
- 補正後VIT: 260
- Lv: 150
- HP基本値 = INT(93 + (260 + 22.41) × 150 / 3)
- HP基本値 = INT(93 + 282.41 × 50)
- HP基本値 = INT(93 + 14120.5)
- HP基本値 = INT(14213.5) = 14213

#### 3. HP%補正適用
```
HP%適用後 = INT(HP基本値 × (1 + HP%/100))
```

**構成要素:**
- **HP%**: 装備/プロパティとセットしてあるクリスタ、バフアイテムのHP%の合計

**計算例:**
- HP基本値: 14213
- HP%: 25% (装備+クリスタ+バフアイテム)
- HP%適用後 = INT(14213 × (1 + 25/100))
- HP%適用後 = INT(14213 × 1.25)
- HP%適用後 = INT(17766.25) = 17766

#### 4. 最終HP計算
```
最終HP = HP%適用後 + HP固定値
```

**構成要素:**
- **HP固定値**: 装備/プロパティとセットしてあるクリスタ、バフアイテムのHP固定値の合計

**計算例:**
- HP%適用後: 17766
- HP固定値: 200 (装備+クリスタ+バフアイテム)
- 最終HP = 17766 + 200 = 17966

### 完全計算例
**入力値:**
- ステータスのVIT: 200
- Lv: 150
- VIT%: 15%
- VIT固定値: 30
- HP%: 25%
- HP固定値: 200

**計算手順:**
1. 補正後VIT = 200 × (1 + 15/100) + 30 = 260
2. HP基本値 = INT(93 + (260 + 22.41) × 150 / 3) = INT(14213.5) = 14213
3. HP%適用後 = INT(14213 × (1 + 25/100)) = INT(17766.25) = 17766
4. 最終HP = 17766 + 200 = 17966

## MP（マジックポイント）計算

### 基本計算式
```
MP = INT(INT(Lv+99+TEC+補正後INT/10)*(1+MP%/100))+MP固定値
```

**注意:** `INT(数値)`は小数点以下を切り捨てる関数（ステータスのINTとは異なる）
- 例: INT(-2.7) = -3

### 詳細計算

#### 1. 補正後INT計算
```
補正後INT = INT(基礎INT × (1 + INT%/100)) + INT固定値
```

**構成要素:**
- **INT%**: 装備/プロパティとセットしてあるクリスタ、バフアイテムのINT%の合計
- **INT固定値**: 装備/プロパティとセットしてあるクリスタ、バフアイテムのINT固定値の合計

**計算例:**
- 基礎INT: 200
- INT%: 10% (装備+クリスタ)
- INT固定値: 20 (装備+クリスタ)
- 補正後INT = INT(200 × (1 + 10/100)) + 20 = INT(200 × 1.10) + 20 = INT(220) + 20 = 240

#### 2. MP基本値計算
```
MP基本値 = INT(Lv + 99 + TEC + 補正後INT/10)
```

**構成要素:**
- **Lv**: ステータスのレベル
- **TEC**: ステータスのTEC
- **補正後INT**: 上記で計算した補正後INT

**計算例:**
- Lv: 150
- TEC: 80
- 補正後INT: 240
- MP基本値 = INT(150 + 99 + 80 + 240/10)
- MP基本値 = INT(150 + 99 + 80 + 24)
- MP基本値 = INT(353) = 353

#### 2. MP%補正適用
```
MP%適用後 = INT(MP基本値 × (1 + MP%/100))
```

**構成要素:**
- **MP%**: 装備/プロパティとセットしてあるクリスタ、バフアイテムのMP%の合計

**計算例:**
- MP基本値: 353
- MP%: 30% (装備+クリスタ+バフアイテム)
- MP%適用後 = INT(353 × (1 + 30/100))
- MP%適用後 = INT(353 × 1.30)
- MP%適用後 = INT(458.9) = 458

#### 3. 最終MP計算
```
最終MP = MP%適用後 + MP固定値
```

**構成要素:**
- **MP固定値**: 装備/プロパティとセットしてあるクリスタ、バフアイテムのMP固定値の合計

**計算例:**
- MP%適用後: 458
- MP固定値: 100 (装備+クリスタ+バフアイテム)
- 最終MP = 458 + 100 = 558

### 完全計算例
**入力値:**
- Lv: 150
- TEC: 80
- 基礎INT: 200
- INT%: 10%
- INT固定値: 20
- MP%: 30%
- MP固定値: 100

**計算手順:**
1. 補正後INT = INT(200 × (1 + 10/100)) + 20 = INT(220) + 20 = 240
2. MP基本値 = INT(150 + 99 + 80 + 240/10) = INT(353) = 353
3. MP%適用後 = INT(353 × (1 + 30/100)) = INT(458.9) = 458
4. 最終MP = 458 + 100 = 558

## 実装における注意点

### 端数処理
- **HP計算**: INT()関数による切り捨て処理を2段階で実施
  - HP基本値計算時: `INT(93+(補正後VIT+22.41)*Lv/3)`
  - HP%適用時: `INT(HP基本値*(1+HP%/100))`
- **MP計算**: INT()関数による切り捨て処理を2段階で実施
  - MP基本値計算時: `INT(Lv+99+TEC+総INT/10)`
  - MP%適用時: `INT(MP基本値*(1+MP%/100))`
- **負数の切り捨て**: INT(-2.7) = -3（より小さい整数）

## 異常耐性計算

### 基本計算式
```
異常耐性(%) = INT(MEN/3.4) + 異常耐性%
```

**注意:** `INT(数値)`は小数点以下を切り捨てる関数

### 詳細計算

#### 構成要素
- **MEN**: ステータスのMEN（基本値、装備補正なし）
- **異常耐性%**: 装備/プロパティ、クリスタ、バフアイテム、料理からの異常耐性%補正の合計

#### 計算例
**入力値:**
- MEN: 100
- 異常耐性%: 15% (装備+クリスタ+バフアイテム)

**計算手順:**
1. MEN基礎計算 = INT(100/3.4) = INT(29.41) = 29
2. 最終異常耐性 = 29 + 15 = 44%

## ASPD（アタックスピード）計算

### 基本計算式
```
ASPD = INT((Lv + ステータスASPD + 武器種補正値) × (1 + ASPD%/100)) + ASPD固定値
```

**注意:** `INT(数値)`は小数点以下を切り捨てる関数

### ステータスASPD計算

武器種に応じてステータスからASPDを算出：

#### 武器種別ステータスASPD計算式

| 武器種 | 計算式 |
|--------|--------|
| 片手剣 | STR × 0.2 + AGI × 4.2 |
| 両手剣 | STR × 0.2 + AGI × 2.1 |
| 双剣 | STR × 0.2 + AGI × 4.2 |
| 弓 | DEX × 0.2 + AGI × 3.1 |
| 自動弓 | DEX × 0.2 + AGI × 2.2 |
| 杖 | AGI × 1.8 + INT × 0.2 |
| 魔道具 | AGI × 4.0 + INT × 0.2 |
| 手甲 | STR × 0.1 + DEX × 0.1 + AGI × 4.6 |
| 旋風槍 | STR × 0.2 + AGI × 3.5 |
| 抜刀剣 | STR × 0.3 + AGI × 3.9 |
| 素手 | AGI × 9.6 |

### 武器種補正値

各武器種固有の基本ASPD値：

| 武器種 | 補正値 |
|--------|--------|
| 片手剣 | 100 |
| 両手剣 | 50 |
| 双剣 | 100 |
| 弓 | 75 |
| 自動弓 | 30 |
| 杖 | 60 |
| 魔道具 | 900 |
| 手甲 | 120 |
| 旋風槍 | 25 |
| 抜刀剣 | 200 |
| 素手 | 1000 |

### 計算例（片手剣）

**入力値:**
- Lv: 150
- STR: 200（補正後）
- AGI: 150（補正後）
- 武器種: 片手剣
- ASPD%: 20%
- ASPD固定値: 50

**計算手順:**
1. ステータスASPD = STR × 0.2 + AGI × 4.2 = 200 × 0.2 + 150 × 4.2 = 40 + 630 = 670
2. 武器種補正値 = 100（片手剣）
3. ASPD%適用前 = 150 + 670 + 100 = 920
4. ASPD%適用後 = INT(920 × (1 + 20/100)) = INT(920 × 1.20) = INT(1104) = 1104
5. 最終ASPD = 1104 + 50 = 1154

### 構成要素

**ASPD%の構成:**
- 装備/プロパティのASPD%補正
- クリスタのASPD%補正
- バフアイテムのASPD%補正

**ASPD固定値の構成:**
- 装備/プロパティのASPD固定値補正
- クリスタのASPD固定値補正
- バフアイテムのASPD固定値補正

### HP計算順序（新計算式）
1. **VIT補正計算**: ステータスVIT × (1 + VIT%/100) + VIT固定値
2. **HP基本値計算**: INT(93 + (補正後VIT + 22.41) × Lv / 3)
3. **HP%補正適用**: INT(HP基本値 × (1 + HP%/100))
4. **HP固定値加算**: HP%適用後 + HP固定値

### MP計算順序（新計算式）
1. **補正後INT計算**: INT(基礎INT × (1 + INT%/100)) + INT固定値
2. **MP基本値計算**: INT(Lv + 99 + TEC + 補正後INT/10)
3. **MP%補正適用**: INT(MP基本値 × (1 + MP%/100))
4. **MP固定値加算**: MP%適用後 + MP固定値

### TypeScript実装例
```typescript
interface BasicStatsCalculation {
  calculateHP(stats: BaseStats, allBonuses: AllBonuses): number {
    // 1. 補正後VIT計算
    const vitPercent = allBonuses.VIT_Rate || 0
    const vitFixed = allBonuses.VIT || 0
    const adjustedVIT = stats.VIT * (1 + vitPercent / 100) + vitFixed
    
    // 2. HP基本値計算
    const baseHP = Math.floor(93 + (adjustedVIT + 22.41) * stats.level / 3)
    
    // 3. HP%補正適用
    const hpPercent = allBonuses.HP_Rate || 0
    const hpAfterPercent = Math.floor(baseHP * (1 + hpPercent / 100))
    
    // 4. HP固定値加算
    const hpFixed = allBonuses.HP || 0
    
    // 5. 最終HP
    return hpAfterPercent + hpFixed
  }

  calculateMP(stats: BaseStats, allBonuses: AllBonuses): number {
    // 1. 補正後INT計算
    const intPercent = allBonuses.INT_Rate || 0
    const intFixed = allBonuses.INT || 0
    const adjustedINT = Math.floor(stats.INT * (1 + intPercent / 100)) + intFixed
    
    // 2. MP基本値計算
    const baseMP = Math.floor(stats.level + 99 + stats.TEC + adjustedINT / 10)
    
    // 3. MP%補正適用
    const mpPercent = allBonuses.MP_Rate || 0
    const mpAfterPercent = Math.floor(baseMP * (1 + mpPercent / 100))
    
    // 4. MP固定値加算
    const mpFixed = allBonuses.MP || 0
    
    // 5. 最終MP
    return mpAfterPercent + mpFixed
  }
}

// AllBonusesはequipment, crystal, food, buffの全補正値をまとめたもの
interface AllBonuses {
  VIT?: number          // VIT固定値の合計
  VIT_Rate?: number     // VIT%の合計
  INT?: number          // INT固定値の合計
  INT_Rate?: number     // INT%の合計
  HP?: number           // HP固定値の合計
  HP_Rate?: number      // HP%の合計
  MP?: number           // MP固定値の合計
  MP_Rate?: number      // MP%の合計
  // その他のステータス...
}
```

## 検証データ

### HP計算検証例（新計算式）
| VIT | Lv | VIT% | VIT固定 | HP% | HP固定 | 期待HP | 実測HP | 状態 |
|-----|----|----- |---------|-----|--------|--------|--------|------|
| 100 | 100 | 0% | 0 | 0% | 0 | 4776 | - | 🔄 |
| 200 | 150 | 15% | 30 | 25% | 200 | 17966 | - | 🔄 |
| 300 | 200 | 20% | 50 | 30% | 300 | 33614 | - | 🔄 |

**計算詳細例（VIT:200, Lv:150）:**
1. 補正後VIT = 200 × 1.15 + 30 = 260
2. HP基本値 = INT(93 + (260 + 22.41) × 150 / 3) = 14213
3. HP%適用後 = INT(14213 × 1.25) = 17766
4. 最終HP = 17766 + 200 = 17966

### MP計算検証例（新計算式）
| Lv | TEC | 基礎INT | INT% | INT固定 | MP% | MP固定 | 期待MP | 実測MP | 状態 |
|----|-----|---------|------|---------|-----|--------|--------|--------|------|
| 100 | 50 | 100 | 0% | 0 | 0% | 0 | 259 | - | 🔄 |
| 150 | 80 | 200 | 10% | 20 | 30% | 100 | 558 | - | 🔄 |
| 200 | 100 | 300 | 15% | 30 | 40% | 150 | 722 | - | 🔄 |

**計算詳細例（Lv:150, TEC:80, 基礎INT:200）:**
1. 補正後INT = INT(200 × 1.10) + 20 = 240
2. MP基本値 = INT(150 + 99 + 80 + 240/10) = 353
3. MP%適用後 = INT(353 × 1.30) = 458
4. 最終MP = 458 + 100 = 558

**凡例:**
- ✅: 検証済み（正確）
- 🔄: 検証待ち
- ❌: 要修正

## 更新履歴

| 日付 | 更新内容 | 備考 |
|------|----------|------|
| 2024-06-23 | HP・MP計算式の初期作成 | 基本的な計算式を記述 |
| 2024-06-23 | HP計算式を正確な式に修正 | INT()関数使用、補正後VIT導入、2段階計算に変更 |
| 2024-06-23 | MP計算式を正確な式に修正 | INT()関数使用、TECとINT活用、2段階計算に変更 |

## 関連ドキュメント
- [計算式概要](./overview.md)
- [装備品補正値計算](./equipment-bonuses.md)
- [クリスタ効果計算](./crystal-effects.md)