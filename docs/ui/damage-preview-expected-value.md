# DamagePreview 期待値表示設計書

## 概要
DamagePreview.tsx において威力オプションが「期待値」に設定された場合の UI 表示と期待値計算に関する設計書。

## UI 表示設計

### 表示切り替え
威力オプションが「期待値」の場合、DamagePreview の上部にある現在の計算結果エリアから、慣れ倍率の上部のダメージ計算結果 UI を入れ替えて表示する。

### 期待値表示レイアウト
3カラム構成で左から以下の情報を表示：

1. **期待値**
   - 期待値によるダメージ計算結果
   - 数値表示

2. **平均安定率**
   - 計算に使用された平均安定率
   - パーセンテージ表示

3. **威力発揮率**
   - 威力の発揮率
   - パーセンテージ表示

### レスポンシブ対応
- デスクトップ：3カラム横並び
- モバイル：必要に応じて縦積み表示を検討

## 実装方針

### 表示条件
- 威力オプションが「期待値」に設定されている場合のみ表示
- その他の威力オプション（最小値、最大値など）の場合は従来通りの表示

### 表示位置
- 現在の計算結果エリア（慣れ倍率の上部）に配置
- 既存のダメージ計算結果 UI と入れ替え表示

## タブメニュー設計

### タブメニュー配置
期待値、平均安定率、威力発揮率の3カラム表示の下部にタブメニューを配置。

### タブ構成
左から以下の4つのタブで構成：

1. **基本情報**
   - 基本的なダメージ計算情報を表示

2. **割合表示**
   - ダメージの割合に関する詳細情報を表示

3. **一時記録**
   - 一時的な記録データの表示・管理
   - キャプチャボタンで現在の値を記録

4. **比較設定**
   - 比較機能に関する設定・表示
   - ※後々実装予定（保留）

### タブ表示仕様
- タブは横並びで表示
- デフォルトでは何も選択されていない状態（コンテンツエリアは非表示）
- タブをクリックすると該当するコンテンツエリアが表示される
- アクティブなタブは視覚的に強調表示
- 同じタブを再クリックするとコンテンツエリアを閉じることができる

## タブコンテンツ設計

### 基本情報タブ
基本的なダメージ計算情報を表示。

#### 表示内容
※複数HITの場合、表示は全ての平均値になります。

**1. クリティカル発生率... 100%**

◎自身のクリティカル率： 86

◎クリティカル発生率100%に必要なクリティカル率： 100

※確定クリティカル特性の場合は、クリティカル発生率100%になります。

**2. 命中率... 100%**

◎自身のHIT値： 773

◎命中率100%に必要なHIT値： 0

※魔法/必中特性の場合は、命中率100%になります。

#### 表示仕様
- 各項目は番号付きで表示
- パーセンテージ表示は小数点以下1桁まで
- 数値は右詰めで表示
- 注釈は※マークで表示
- 詳細情報は◎マークで表示

### 一時記録タブ
現在の期待値計算結果を一時的に記録・表示する機能。

#### 機能概要
- **キャプチャボタン**: 現在の期待値、平均安定率、威力発揮率を記録
- **記録データ**: 直近の1回のキャプチャのみ保存
- **上書き保存**: 新しいキャプチャで前回の記録を上書き
- **保存範囲**: 全体で1つのキャプチャデータを管理（セーブデータごとではない）

#### データ保存仕様
- **ローカルストレージ**: 既存のDamagePreviewキャプチャと同様に全体で1つの共通保存領域を使用
- **保存データ**: 期待値、平均安定率、威力発揮率の3つの値
- **キー管理**: DamagePreviewの既存キャプチャとは別の独立したローカルストレージキーを使用

#### 表示内容
**キャプチャボタン**
- タブ上部に配置
- 「現在の値をキャプチャ」などのラベル
- クリックで現在表示中の3つの値を記録

**記録データ表示**
- キャプチャした期待値
- キャプチャした平均安定率
- キャプチャした威力発揮率
- キャプチャ日時（任意）

#### 表示仕様
- 記録がない場合は「記録データがありません」などのメッセージを表示
- 記録データは3カラム表示と同様のレイアウトで表示
- キャプチャボタンは常時表示

### 割合表示タブ
ダメージの発生割合と与ダメージ割合をグラフィカルに表示する機能。

#### 表示内容
**1. 発生割合（%）**
- 各ダメージタイプの発生確率を0-100%の割合グラフで表示
- 表示項目：Critical、Graze、白ダメ、ミス
- グラフ形式：水平バーグラフ

**2. 与ダメージ割合（%）**
- 実際にダメージを与えるタイプの割合を0-100%で表示（ミスを除外）
- 表示項目：Critical、Graze、白ダメ（ミスは除外）
- グラフ形式：水平バーグラフ
- 計算基準：Critical + Graze + 白ダメ = 100%として正規化

#### 発生割合の計算仕様
発生割合は基本情報タブのクリティカル発生率と命中率を基に計算される。

**基本構成:**
- `Critical + Graze` = クリティカル発生率
- `白ダメ + ミス` = 100% - クリティカル発生率

**計算ロジック:**
1. **クリティカル系（Critical + Graze）**
   - 合計：基本情報のクリティカル発生率（例：91%）
   - 内訳：命中率を基にCriticalとGrazeに分配
   - Critical：クリティカル発生率 × 命中率（例：91% × 64% = 58.24%）
   - Graze：クリティカル発生率 × (100% - 命中率)（例：91% × 36% = 32.76%）

2. **非クリティカル系（白ダメ + ミス）**
   - 合計：100% - クリティカル発生率（例：9%）
   - 内訳：命中率を基に白ダメとミスに分配
   - 白ダメ：非クリティカル系 × 命中率（例：9% × 64% = 5.76%）
   - ミス：非クリティカル系 × (100% - 命中率)（例：9% × 36% = 3.24%）

**計算例:**
- クリティカル発生率：91%
- 命中率：64%
- 結果：
  - Critical：91% × 64% = 58.24%
  - Graze：91% × 36% = 32.76%
  - 白ダメ：9% × 64% = 5.76%
  - ミス：9% × 36% = 3.24%
  - 合計：58.24% + 32.76% + 5.76% + 3.24% = 100%

#### 与ダメージ割合の計算仕様
与ダメージ割合は発生割合からミスを除外し、実際にダメージを与える部分のみを100%として正規化する。

**計算ロジック:**
1. **発生割合から有効ダメージ部分を抽出**
   - 有効ダメージ合計 = Critical + Graze + 白ダメ
   - ミスは除外（ダメージを与えないため）

2. **正規化計算**
   - Critical割合 = Critical ÷ 有効ダメージ合計 × 100%
   - Graze割合 = Graze ÷ 有効ダメージ合計 × 100%
   - 白ダメ割合 = 白ダメ ÷ 有効ダメージ合計 × 100%

**計算例:**
- 発生割合：Critical: 58.24%、Graze: 32.76%、白ダメ: 5.76%、ミス: 3.24%
- 有効ダメージ合計：58.24% + 32.76% + 5.76% = 96.76%
- 与ダメージ割合：
  - Critical：58.24% ÷ 96.76% × 100% = 60.19%
  - Graze：32.76% ÷ 96.76% × 100% = 33.86%
  - 白ダメ：5.76% ÷ 96.76% × 100% = 5.95%
  - 合計：60.19% + 33.86% + 5.95% = 100%

#### 表示仕様
- 2つのグラフを縦に配置
- 発生割合グラフ：4つのカテゴリ（Critical、Graze、白ダメ、ミス）で構成
- 与ダメージ割合グラフ：3つのカテゴリ（Critical、Graze、白ダメ）で構成（ミス除外）
- パーセンテージ表示は小数点以下1桁まで
- カテゴリごとに異なる色分けで視覚的に区別

## 計算式設計

### 必要パラメーター
基本情報タブでの計算に必要なパラメーター：

1. **クリティカル発生率計算用**
   - 自身のクリティカル率：StatusPreviewの基本ステータスのクリティカル率
   - 敵の確定クリティカルの値：EnemyFormの確定クリティカルの値

2. **命中率計算用**
   - 自身のHIT値：StatusPreviewの基本ステータスのHIT
   - 命中100%に必要なHIT値：EnemyFormの必要HIT
   - 攻撃スキルの消費MP：AttackSkillFormでセットされているスキルの消費MP

### 計算式の状況

#### クリティカル発生率計算式（検証中）
敵の確定クリティカル値によって計算式が分岐：

**敵の確定クリティカル ≤ 100の場合:**
```
クリティカル発生率 = (自身のクリティカル率 / 敵の確定クリティカル) × 100
```

**敵の確定クリティカル > 100の場合:**
```
クリティカル発生率 = 100 - (敵の確定クリティカル - 自身のクリティカル率)
```

**計算例:**
- 自身のクリティカル率121、敵の確定クリティカル130の場合
- 130 > 100 なので第2式を使用
- `100 - (130 - 121) = 100 - 9 = 91%`

#### 命中率計算式
命中率の計算は基本計算に攻撃スキルの補正が加算される：

**基本命中率:**
```
基本命中率 = 100 - (必要HIT - 自身のHIT) / 3
```

**攻撃スキル補正:**
```
スキル補正 = 攻撃スキルの消費MP / 10
```

**最終命中率:**
```
命中率 = 基本命中率 + スキル補正（0%～100%でキャップ）
```

**計算例:**
- 必要HIT: 500、自身のHIT: 773、攻撃スキル: ムーンスラッシュ（消費MP: 400）の場合
- 基本命中率 = `100 - (500 - 773) / 3 = 100 - (-273) / 3 = 100 + 91 = 191%`
- スキル補正 = `400 / 10 = 40%`
- 最終命中率 = `191% + 40% = 231%` → 100%でキャップ

- 必要HIT: 1000、自身のHIT: 690、攻撃スキルなし（消費MP: 0）の場合
- 基本命中率 = `100 - (1000 - 690) / 3 = 100 - 310 / 3 = 100 - 103.3 = -3.3%`
- スキル補正 = `0 / 10 = 0%`
- 最終命中率 = `-3.3% + 0% = -3.3%` → 0%でキャップ

**必要パラメーター追加:**
- 攻撃スキルの消費MP：AttackSkillFormでセットされているスキルの消費MP

**注意事項:**
- クリティカル発生率計算式は現在検証中のため、実装前に最終確認が必要

### 命中とGrazeの仕様

#### 命中判定の基本仕様
命中判定は計算した命中率と各武器種固有の最低保証HIT率によって決まる。

**命中率 >= 保証HIT率の場合:**
- 命中率通りに命中する
- 命中しなかった場合はミスになる

**命中率 < 保証HIT率の場合:**
- 命中率通りの命中に加え、`保証HIT率 - 命中率`分だけGrazeになる
- 命中しなかった場合はミスになる

#### Grazeの発生条件
Grazeはクリティカル時と非クリティカル時で扱いが異なる：

**クリティカル発生時:**
- 命中率が足りない場合、クリティカルはGrazeになる

**非クリティカル発生時（白ダメージ）:**
- 命中率が足りない場合、Grazeまたはミスになる

#### 最低保証HIT率
各武器種の最低保証HIT率は以下の通り：

| 武器種 | 最低保証HIT率 |
|--------|---------------|
| 片手剣 | 25% |
| 両手剣 | 15% |
| 弓 | 10% |
| 自動弓 | 5% |
| 杖 | 30% |
| 魔導具 | 10% |
| 手甲 | 10% |
| 旋風槍 | 20% |
| 抜刀剣 | 30% |
| 素手 | 50% |

**計算例:**
- 命中率: 40%、武器: 片手剣（保証HIT: 25%）の場合
- 40% >= 25% なので命中率通りに40%命中、60%ミス

- 命中率: 20%、武器: 片手剣（保証HIT: 25%）の場合
- 20% < 25% なので20%命中、5%Graze（25% - 20%）、75%ミス（100% - 20% - 5%）

## 今後の実装予定
- 期待値計算ロジックの詳細設計（計算式確定後）
- 各カラムの詳細な表示仕様
- 残りのタブコンテンツ詳細設計
- インタラクション設計（ツールチップ、詳細表示など）
- 最低保証HIT率を考慮した命中・グレイズ・ミス判定の実装