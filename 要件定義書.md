# トーラムオンライン ダメージ計算ツール 要件定義書

## 1. プロジェクト概要
MMORPGトーラムオンラインのダメージ計算を行うWebアプリケーション

## 2. 機能要件

### 2.1 対象となるダメージ計算
- 通常攻撃のダメージ計算
- スキル攻撃のダメージ計算

### 2.2 入力項目

#### 2.2.1 キャラクターステータス
- STR（力）: 1-510
- INT（知力）: 1-510
- VIT（体力）: 1-510
- AGI（俊敏性）: 1-510
- DEX（器用さ）: 1-510
- CRT（クリティカル）: 1-255
- MEN（精神力）: 1-255
- TEC（技術力）: 1-255
- LUK（運）: 1-255
- レベル: 1-510

#### 2.2.2 武器関連
**メイン武器**
- 武器種（片手剣、両手剣、杖など）
- 武器ATK：0-1500
- 安定率：0-100
- 精錬値：0-15

**サブ武器**
- 武器種（ナイフ、矢など）
- 武器ATK：0-1500
- 安定率：0-100
- 精錬値：0-15

**クリスタ（プリセット選択式）**
- 武器クリスタ（2枠）
  - ドン・プロフンド（ATK10%, STR7%, クリティカル率8%, DEF -27%）
  - 黒衣の聖誕姫（例プロパティ）
- 防具クリスタ（2枠）
  - ccc（例プロパティ）
  - ddd（例プロパティ）
- 追加クリスタ（2枠）
  - aaa（例プロパティ）
  - bbb（例プロパティ）
- 特殊クリスタ（2枠）
  - eee（例プロパティ）
  - fff（例プロパティ）
- ノーマルクリスタ
  - 全てのスロット（武器、防具、追加、特殊）に装着可能
  - 汎用的なプロパティを持つクリスタ

**クリスタデータ管理方式**
- プリセットクリスタ: JSONファイルで管理（`src/data/crystals.json`）
- ユーザーカスタムクリスタ: LocalStorageで管理
- データ統合: プリセット + ユーザーカスタムを統合してリスト表示

**クリスタ選択UI**
- オーバーレイモーダル方式での選択画面
- グリッドレイアウトでのクリスタ一覧表示
- クリスタカード形式（名前、効果、説明表示）
- タイプ別フィルタリング（専用/ノーマル）
- 背景クリック・ESCキーでモーダル閉じる
- 検索・絞り込み機能（将来実装予定）

#### 2.2.3 装備システム

**装備カテゴリ**
- メイン装備
- 体装備
- 追加装備
- 特殊装備
- サブ武器
- オシャレ装備1
- オシャレ装備2
- オシャレ装備3
- 自由入力1
- 自由入力2
- 自由入力3
- 武器クリスタ
- 防具クリスタ
- 追加クリスタ
- 特殊クリスタ

**装備プリセット選択機能**
- プリセット装備: JSONファイルで管理（`src/data/equipments.json`）
- ユーザーカスタム装備: LocalStorageで管理
- データ統合: プリセット + ユーザーカスタムを統合してリスト表示

**装備選択UI**
- タブ切り替え式装備管理画面（8つの装備スロット対応）
- 各装備スロットでプリセット選択機能
- オーバーレイモーダル方式での装備選択画面（クリスタ選択と同一UI）
- グリッドレイアウトでの装備一覧表示
- 装備カード形式（名前、基本性能、プロパティ表示）
- 装備タイプ別フィルタリング（武器/防具/アクセサリ/オシャレ等）
- 手動プロパティ入力機能との併用（プリセット選択後に微調整可能）
- 背景クリック・ESCキーでモーダル閉じる
- 検索・絞り込み機能（将来実装予定）

**装備データ構造**
- 装備ID、装備名、装備タイプ
- 基本性能（ATK、DEF、安定率等）
- 付与プロパティ（各種%効果、固定値効果）

#### 2.2.4 各装備のプロパティ

**プロパティ設定値の範囲**
- %系プロパティ: -1000 ～ 1000
- 固定値プロパティ: -99999 ～ 99999

**プロパティ一覧**
- ATK%
- ATK
- MATK%
- MATK
- 武器ATK%
- 武器ATK
- 物理貫通%
- 魔法貫通%
- 属性有利%
- 抜刀威力%
- 抜刀威力
- 近距離威力%
- 遠距離威力%
- クリティカルダメージ%
- クリティカルダメージ
- クリティカル率%
- クリティカル率
- 安定率%
- HP%
- HP
- MP
- STR%
- STR
- INT%
- INT
- VIT%
- AGI%
- AGI
- DEX%
- DEX
- 命中%
- 命中
- 回避%
- 回避
- 攻撃速度%
- 攻撃速度
- 詠唱速度%
- 詠唱速度
- 行動速度%
- 攻撃MP回復%
- 攻撃MP回復
- 物理耐性%
- 魔法耐性%
- 異常耐性%
- ヘイト%
- 復帰短縮%
- HP自然回復%
- HP自然回復
- MP自然回復%
- MP自然回復
- 防御崩し%
- 先読み%
- Guard力%
- Guard回復%
- Avoid回復%
- 道具速度
- 絶対命中%
- 絶対回避%
- ATK+(STR)%
- ATK+(INT)%
- ATK+(VIT)%
- ATK+(AGI)%
- ATK+(DEX)%
- MATK+(STR)%
- MATK+(INT)%
- MATK+(VIT)%
- MATK+(AGI)%
- MATK+(DEX)%
- 火耐性%
- 水耐性%
- 風耐性%
- 地耐性%
- 光耐性%
- 闇耐性%
- 無耐性%
- 直線軽減%
- 突進軽減%
- 弾丸軽減%
- 周囲軽減%
- 範囲軽減%
- 痛床軽減%
- 隕石軽減%
- 射刃軽減%
- 吸引軽減%
- 爆発軽減%
- 物理バリア
- 魔法バリア
- 割合バリア
- バリア速度%
- 物理追撃%
- 魔法追撃%

#### 2.2.5 料理（バフ効果）

**料理プリセット選択機能**
- 料理スロット: 5枠
- selectドロップダウン方式での料理選択
- 各料理の効果レベル設定: 1-10（「なし」を除く）

**料理一覧**
- なし
- おかかおにぎり（STR）: 1-10
- 鮭おにぎり（DEX）: 1-10
- 梅干しおにぎり（INT）: 1-10
- 明太子おにぎり（AGI）: 1-10
- ツナマヨおにぎり（VIT）: 1-10
- しょうゆラーメン（命中）: 1-10
- 属性パスタ（属性有利共通）: 1-10
- たこ焼き（クリ率）: 1-10
- 焼きそば（攻撃MP回復）: 1-10
- 黄金チャーハン（HP）: 1-10
- あんかけチャーハン（MP）: 1-10
- マルゲリータピザ（武器ATK+）: 1-10
- ディアボラピザ（ATK+）: 1-10
- シーフードピザ（MATK+）: 1-10
- ビーフシチュー（ヘイト+）: 1-10
- ホワイトシチュー（ヘイト-）: 1-10
- ビーフバーガー（物理耐性）: 1-10
- フィッシュバーガー（魔法耐性）: 1-10

#### 2.2.6 バフスキル設定

**バフスキルシステム**
- 各種バフスキルのオン/オフ設定機能
- スキルレベルや特殊パラメータの調整機能
- スキル系統別のグループ化表示
- リアルタイムでのダメージ計算への反映

**詳細仕様**
- **参照**: `buff-skill.md`に詳細な仕様を記載
- **対象スキル**: 合計58種類のバフスキル
  - マスタリ系、各武器スキル系統
  - サポート系、バトル系、ペット系など
- **設定パラメータ**: スキルごとに異なる設定項目

**特殊パラメータスキル**
- **エターナルナイトメア**: スキルレベル（1-10）+ 使用スキルポイント（25-80）
- **ナイトプレッジ**: スキルレベル（1-10）+ プレイヤー数（0-4）+ 盾精錬値（1-15）
- **ブレイブ**: バフ使用者フラグ（自己使用: 1 / 他者使用: 0）
- **情熱の歌**: カウント数（1-10）- 重ねがけスキル
- **神速の捌手**: 重ねがけ回数（1-3）- 重ねがけ制限付きスキル

**UI操作方式**
- スキル名クリックでポップオーバー表示（画面中央固定）
- ポップオーバー内で複数パラメータの同時編集
- 適用/キャンセルボタンによる一括変更確定
- スキル名に現在のパラメータ値を表示（例: ナイトプレッジ/10）
  - スキルレベル（1-10）
  - 重ねがけ数、プレイヤー数、精錬値など

**バフスキルUI設計**
- グリッドレイアウト: 5カラム（レスポンシブ対応）で全スキルを平坦表示
- スキルカード構成:
  - カテゴリラベル（上部）: スキル系統名を表示
  - スキル名（中央左）: クリックでポップオーバー表示 + パラメータ値表示（例: ハルバードマスタリ/10）
  - 有効・無効ボタン（中央右）: 2つのボタンで状態表示・切り替え
    - 有効ボタン: スキルが有効時は緑色背景 + 白文字、無効時はグレー色背景 + グレー文字
    - 無効ボタン: スキルが無効時は赤色背景 + 白文字、有効時はグレー色背景 + グレー文字
    - 各ボタンクリックで直接状態変更
- ポップオーバー機能: スキル名クリックで専用フォームを表示
  - パラメータ入力: スキルレベル、重ねがけ数等の詳細設定
  - 適用/キャンセルボタン
- バリデーション: 範囲制限とエラー表示

**武器種連動スキル自動表示機能**

**マスタリスキル自動表示**
- メイン武器の武器種に応じて該当するマスタリスキルを自動表示
- 武器種とマスタリスキルの対応関係:
  - 素手: シールドマスタリ
  - 片手剣: ブレードマスタリ + シールドマスタリ
  - 双剣: ブレードマスタリ + デュアルマスタリ
  - 両手剣: ブレードマスタリ
  - 手甲: マーシャルマスタリ + シールドマスタリ
  - 旋風槍: ハルバードマスタリ
  - 抜刀剣: 該当なし（マスタリスキル全体を非表示）
  - 弓: シュートマスタリ
  - 自動弓: シュートマスタリ + シールドマスタリ
  - 杖: マジックマスタリ + シールドマスタリ
  - 魔導具: マジックマスタリ

**武器種専用スキル自動表示**
- メイン武器の武器種に応じて該当する専用スキルを自動表示
- 武器種と専用スキルの対応関係:
  - 旋風槍: トールハンマー、トルネードランス、会心の捌き（ハルバードスキル）

**共通仕様**
- 非該当のスキルは表示されない（UI上で非表示）
- 武器種変更時の動作:
  - 変更前のマスタリスキル・専用スキル設定は**リセット**される
  - 新しい武器種に対応するスキルはデフォルト状態（無効・初期パラメータ）で表示

#### 2.2.7 敵（防御側）の情報

**敵情報プリセット選択機能**
- プリセット敵情報: JSONファイルで管理（`src/data/enemies.json`）
- ユーザーカスタム敵情報: LocalStorageで管理
- データ統合: プリセット + ユーザーカスタムを統合してリスト表示

**敵情報選択UI**
- selectドロップダウン方式での敵選択
- プリセット敵情報をリスト表示
- 敵カテゴリ別フィルタリング（モブ/フィールドボス/ボス/レイドボス）
- 手動ステータス入力機能との併用（プリセット選択後に確定クリティカルと必要HITを調整可能）

**敵基本ステータス**
- 敵のDEF（物理防御力）: 0-9999
- 敵のMDEF（魔法防御力）: 0-9999
- 敵のレベル: 1-999
- クリティカル耐性: 0-999 ※プリセット敵情報では0、ユーザーが調整可能
- 必要HIT: 0-9999 ※プリセット敵情報では0、ユーザーが調整可能

**敵データ構造**
- 敵ID、敵名、敵カテゴリ
- 基本ステータス（レベル、DEF、MDEF、物理耐性、魔法耐性、クリティカル耐性※、必要HIT※）
- ※resistCriticalとrequiredHITはプリセットでは0、ユーザーが手動調整してローカルストレージに保存

### 2.3 出力項目
- ダメージ計算結果
- ステータス計算結果

## 3. 非機能要件

### 3.1 UI/UX要件
- 日本語インターフェース
- リアルタイム計算（入力と同時に結果表示）
- レスポンシブデザイン
- モダンなクリスタ選択UI（オーバーレイ + グリッド表示）

### 3.2 技術要件
- Next.js 15 + React 19
- TypeScript
- Tailwind CSS v4
- 状態管理: Zustand（軽量で型安全な状態管理）
- フォームバリデーション: Zod + React Hook Form
- Biome（コード品質・フォーマット）

### 3.3 データ管理要件

#### 3.3.1 アプリ起動時のプリセットデータ初期化
**アプリ起動時の動作フロー**:
```
アプリ起動 → ストレージチェック → メインデータ存在確認 → [存在しない場合]メインデータ作成 → プリセットデータをローカルストレージにコピー → メインデータをセーブデータに設定
```

**プリセットデータのローカルストレージコピー**:
- 初回アクセス時に以下のプリセットデータをローカルストレージにコピー
  - プリセット装備データ（`src/data/equipments.json`）
  - プリセットクリスタデータ（`src/data/crystals.json`）
  - プリセット敵情報データ（`src/data/enemies.json`）
- コピー後は全てローカルストレージから参照
- `isFavorite`プロパティをプリセットデータにも適用可能
- プリセット由来のデータでも数値調整・保存が可能

#### 3.3.2 データ管理方式
- **プリセットデータ**: JSONファイル → 初回時にLocalStorageにコピー
- **ユーザーカスタムデータ**: LocalStorage管理
  - カスタムクリスタ
  - カスタム装備
  - カスタム敵情報
- **統合データアクセス**: ローカルストレージから全データを統一的に管理
- **状態管理**: Zustandによる一元的な状態管理
  - 計算機データの統合管理
  - セーブデータ管理
  - UI状態管理
  - TypeScript型安全性
- データの永続化とインポート/エクスポート対応

#### 3.3.3 状態管理アーキテクチャ
**Zustand Store構成**:
- `CalculatorStore`: メインデータ管理（基本ステータス、武器、装備、クリスタ、料理、敵情報、バフスキル※）
- `SaveDataStore`: セーブデータ管理（作成、切り替え、削除）
- `UIStore`: UI状態管理（モーダル、管理画面表示状態）

※バフスキルはフェーズ2で追加予定

**React Hook Form統合**:
- Zustandとの双方向バインディング
- リアルタイム変更検知とストア更新
- フォーム初期化の最適化
- セーブデータ切り替え時のちらつき防止

## 4. 開発フェーズ

### フェーズ1（完了）
- 入力フォームの実装（基本ステータス、武器、装備、クリスタ、料理、敵情報）
- 基本的なステータス合計表示
- リアルタイム入力対応
- Zustand状態管理システムの導入
- プリセットクリスタ選択システム（JSONベース + モーダルUI）
- タブ切り替え式装備管理画面
- プリセット装備選択システム（JSONベース + モーダルUI）
- プリセット敵情報選択システム（JSONベース + ドロップダウンUI）
- セーブデータ管理機能（作成、切り替え、削除）
- LocalStorageベースのデータ永続化
- 保存ボタンの統一（「現在のデータを保存」に統一、重複削除）

### フェーズ2（次期実装予定）
- **バフスキルシステムの実装**（高優先度）
  - バフスキル設定フォームの実装
  - スキル系統別のグループ化表示
  - オン/オフ切り替えとパラメータ入力
  - Zustand状態管理への統合
- ダメージ計算ロジックの実装
- 計算結果の詳細表示
- ユーザーによるクリスタ編集・保存機能（LocalStorageベース）
- ユーザーによる装備編集・保存機能（LocalStorageベース）
- ユーザーによる敵情報編集・保存機能（LocalStorageベース）
- 装備・クリスタの組み合わせ最適化機能

### フェーズ3（将来）
- 装備セット保存・読み込み機能
- 複数キャラクター管理機能
- 装備・クリスタ・敵情報データのインポート/エクスポート機能
- 検索・絞り込み機能の強化

## 5. 技術的成果と制約事項

### 5.1 技術的成果
- Zustand状態管理による高いパフォーマンス
- React Hook Formとの効率的な統合
- TypeScript型安全性の完全対応
- セーブデータ管理の実装完了
- UI/UXの最適化（ちらつき防止等）

### 5.2 制約事項
- ダメージ計算ロジックは複雑なため、フェーズ2で実装予定
- ユーザーカスタムデータ編集機能は次期フェーズで実装
- 表示形式の詳細は後の設計で決定