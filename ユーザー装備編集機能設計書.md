# ユーザー装備編集・保存機能 設計書

## 1. 機能概要

**目的**: ユーザーが独自の装備を作成・編集し、LocalStorageに保存して再利用できる機能

**対象**: 
- 全装備カテゴリ（mainWeapon, body, additional, special, subWeapon, fashion1-3）
- プリセット装備からの編集と新規作成の両方に対応

## 2. UI/UX設計

### 2.1 装備作成・編集のフロー

#### 2.1.1 新規装備作成フロー
```
装備タブ（例：メイン装備） → [新規登録] ボタン → 装備名入力モーダル → LocalStorageに名前のみ保存 → 既存の入力フォーム画面
```

**手順**:
1. ユーザーが装備タブ（メイン装備、体装備など）を選択
2. 「新規登録」ボタンをクリック
3. 装備名入力モーダルが表示
4. 装備名を入力して「作成」ボタンをクリック
5. **名前のみの空装備がLocalStorageに即座に保存される**
6. モーダルが閉じ、既存の装備入力フォーム画面に遷移
7. 作成された空装備が選択状態になり、プロパティ編集が可能になる

#### 2.1.2 既存装備編集フロー
```
装備選択モーダル → [編集] ボタン → 既存の入力フォーム画面
```

**手順**:
1. プリセット選択ボタンをクリック
2. 装備選択モーダルでユーザー作成装備を選択
3. 「編集」ボタンをクリック
4. モーダルが閉じ、既存の装備入力フォーム画面に遷移
5. 選択した装備の情報がフォームに読み込まれる

### 2.2 装備名入力モーダルの構成
**新規作成時のモーダル（軽量版）**
- **タイトル**: 「新しい{カテゴリ名}を作成」（例：「新しいメイン装備を作成」）
- **入力フィールド**:
  - 装備名（必須、最大50文字）
- **アクションボタン**:
  - 作成、キャンセル

### 2.3 既存入力フォームの拡張
**既存の装備入力フォームに以下を追加**:
- **ユーザー装備編集モード表示**:
  - 現在の状態表示（「編集中: {装備名}」）
  - 装備名変更フィールド
  - 入手方法フィールド（任意）
- **保存・管理ボタン**:
  - **プロパティ保存ボタン**（プロパティ入力後の保存専用）
  - 削除ボタン（編集時のみ）
  - 編集キャンセルボタン

### 2.4 新規登録ボタンの配置
**各装備タブに「新規登録」ボタンを追加**:
- プリセット選択ボタンの隣に配置
- ボタンテキスト: 「新規登録」
- アイコン: プラス記号（+）
- 現在のタブコンテキストに応じて装備カテゴリを自動判定

## 3. データ構造設計

### 3.1 ユーザー装備の識別
```typescript
interface UserEquipment extends PresetEquipment {
  isCustom: true                    // ユーザー作成フラグ
  createdAt: string                // 作成日時 (ISO string)
  updatedAt: string                // 更新日時 (ISO string)
  basedOnId?: string               // 元になったプリセット装備ID（編集時）
}

// 新規作成時のデータ構造（名前のみ）
interface EmptyUserEquipment {
  id: string                       // 自動生成ID
  name: string                     // ユーザー入力の装備名
  category: EquipmentCategory      // 装備カテゴリ
  isCustom: true                   // ユーザー作成フラグ
  createdAt: string               // 作成日時
  updatedAt: string               // 更新日時
  // プロパティは全て空/デフォルト値
  properties: {}                   // 空オブジェクト
  weaponStats?: undefined          // 武器ステータスは未定義
  source?: ""                      // 入手方法は空文字
}
```

### 3.2 LocalStorage管理
**保存キー**: `custom_equipments`
**データ形式**: `UserEquipment[]`

### 3.3 ID生成ルール
```typescript
function generateCustomEquipmentId(): string {
  return `custom_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
}
```

## 4. バリデーション設計

### 4.1 装備フォームバリデーション
```typescript
const equipmentFormSchema = z.object({
  name: z.string().min(1, '装備名は必須です').max(50, '装備名は50文字以内で入力してください'),
  source: z.string().max(100, '入手方法は100文字以内で入力してください').optional(),
  weaponStats: z.object({
    ATK: z.number().min(0).max(1500).optional(),
    stability: z.number().min(0).max(100).optional(),
    refinement: z.number().min(0).max(15).optional(),
  }).optional(),
  properties: z.record(z.number()).refine(
    (data) => validatePropertyRanges(data),
    { message: 'プロパティの値が範囲外です' }
  )
})
```

### 4.2 プロパティ値域チェック
```typescript
const PROPERTY_RANGES: Record<keyof EquipmentProperties, { min: number, max: number }> = {
  'ATK%': { min: -100, max: 100 },
  'ATK': { min: -500, max: 500 },
  'クリティカル率%': { min: -50, max: 50 },
  // ... 全プロパティの範囲定義
}
```

## 5. コンポーネント設計

### 5.1 コンポーネント構成
```
EquipmentEditor/
├── EquipmentNameModal.tsx         // 装備名入力モーダル（軽量版）
├── EquipmentFormExtension.tsx     // 既存フォームの拡張部分
├── UserEquipmentStatusBar.tsx     // 作成・編集状態表示バー
└── hooks/
    ├── useEquipmentEditor.ts      // 編集ロジック
    ├── useEquipmentValidation.ts  // バリデーション
    └── useEquipmentCreation.ts    // 新規作成フロー管理

// 既存コンポーネントの拡張
EquipmentTab/
├── NewEquipmentButton.tsx         // 新規登録ボタン
└── EquipmentSelector.tsx          // プリセット選択（編集ボタン追加）
```

### 5.2 状態管理
```typescript
interface EquipmentEditorState {
  mode: 'edit' | 'idle'              // 'create'モードを削除（即座に保存されるため）
  category: EquipmentCategory
  currentEquipment?: UserEquipment    // 編集中の装備
  formData: {
    name: string
    source: string
    weaponStats?: WeaponStats
    properties: Record<string, number>
  }
  errors: Record<string, string>
  isSubmitting: boolean
  showNameModal: boolean              // 装備名入力モーダルの表示状態
  hasUnsavedChanges: boolean          // 未保存の変更があるかどうか
}

// 装備名入力モーダル用の状態
interface EquipmentNameModalState {
  isOpen: boolean
  category: EquipmentCategory
  name: string
  error?: string
  isCreating: boolean                 // 作成処理中フラグ
}
```

## 6. API設計（utils関数）

### 6.1 ユーザー装備管理関数
```typescript
// src/utils/userEquipmentManager.ts
export function createEmptyUserEquipment(name: string, category: EquipmentCategory): Promise<EmptyUserEquipment>
export function saveUserEquipmentProperties(id: string, properties: Partial<UserEquipment>): Promise<void>
export function updateUserEquipment(id: string, equipment: Partial<UserEquipment>): Promise<void>
export function deleteUserEquipment(id: string): Promise<void>
export function getUserEquipments(): UserEquipment[]
export function getUserEquipmentsByCategory(category: EquipmentCategory): UserEquipment[]
export function getUserEquipmentById(id: string): UserEquipment | undefined
```

### 6.2 統合データ取得の拡張
```typescript
// equipmentDatabase.ts に追加
export function getAllAvailableEquipments(): PresetEquipment[] {
  const presetEquipments = getAllEquipments()
  const userEquipments = getUserEquipments()
  return [...presetEquipments, ...userEquipments]
}
```

## 7. エラーハンドリング

### 7.1 バリデーションエラー
- リアルタイムバリデーション
- フィールド単位のエラー表示
- フォーム送信時の全体バリデーション

### 7.2 保存エラー
- LocalStorage容量オーバー
- データ破損の検出と復旧
- フォールバック処理

## 8. ユーザビリティ考慮事項

### 8.1 編集体験の向上
- プリセット装備からのコピー機能
- プロパティのオートコンプリート
- よく使われるプロパティの推奨表示

### 8.2 データ管理
- 装備の重複チェック
- 作成日時による並び替え
- エクスポート/インポート機能（将来実装）

## 9. 実装優先度

### Phase 1（高優先度）
- 新規登録ボタンによる名前のみ装備作成機能
- プロパティ編集・保存機能（保存ボタン分離）
- 基本的な装備削除機能
- バリデーション
- LocalStorage保存

### Phase 2（中優先度）
- プリセットからのコピー機能
- プロパティ入力の改善
- エラーハンドリングの強化

### Phase 3（低優先度）
- 高度な検索・フィルタリング
- バックアップ・復元機能
- 装備の共有機能

## 10. 技術仕様書との連携

### 10.1 既存インターフェースの活用
- `PresetEquipment`インターフェースを拡張
- `EquipmentProperties`の完全サポート
- `WeaponStats`（mainWeaponカテゴリ専用）の対応

### 10.2 データ統合
- プリセット装備（JSON）とユーザー装備（LocalStorage）の統合表示
- `equipmentDatabase.ts`の拡張による一元管理
- 既存の装備選択UIとの互換性維持

## 11. セキュリティ・データ整合性

### 11.1 データ検証
- 入力値の厳格なバリデーション
- プロパティ値の範囲チェック
- 不正データの検出と除外

### 11.2 LocalStorage管理
- データサイズの監視
- 破損データの自動修復
- バージョン管理による互換性確保

---

**作成日**: 2025-01-16
**対象システム**: トーラムオンライン ダメージ計算ツール
**設計対象**: ユーザー装備編集・保存機能