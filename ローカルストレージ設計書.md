# ローカルストレージ設計書

## 1. 概要

**目的**: トーラムオンライン ダメージ計算ツールにおけるローカルストレージを活用したデータ永続化とセーブデータ管理システムの設計

**対象データ**:
- ユーザーカスタム装備
- ユーザーカスタムクリスタル
- セーブデータ（計算機の全入力状態）

## 2. セーブデータ管理システム

### 2.1 基本コンセプト

**デフォルトセーブデータ**:
- システム起動時に自動的に使用される「メインデータ」
- ユーザーの入力内容が自動保存される
- 削除不可、常に存在する

**ユーザーセーブデータ**:
- ユーザーが任意で作成・管理できるセーブデータ
- 名前付きで保存、複数作成可能
- 作成、読み込み、更新、削除、並び替え、名前変更が可能

### 2.2 セーブデータの構造

```typescript
interface SaveData {
  id: string                    // 一意識別子
  name: string                  // セーブデータ名
  isDefault: boolean            // デフォルトデータフラグ
  createdAt: string            // 作成日時 (ISO string)
  updatedAt: string            // 更新日時 (ISO string)
  order: number                // 表示順序
  data: {
    baseStats: BaseStatsFormData    // キャラクターベースステータス
    weapons: WeaponFormData         // 武器設定
    crystals: CrystalFormData       // クリスタル設定
    equipments: EquipmentFormData   // 装備設定
    enemy: EnemyFormData           // 敵設定
  }
}

// デフォルトセーブデータ
interface DefaultSaveData extends SaveData {
  id: "default"
  name: "メインデータ"
  isDefault: true
  // 削除不可、名前変更不可
}
```

### 2.3 セーブデータ管理UI

#### 2.3.1 セーブデータ選択・管理画面
```
ヘッダー部分に「セーブデータ」ボタン → セーブデータ管理モーダル
```

**モーダル構成**:
- **タイトル**: 「セーブデータ管理」
- **現在のセーブデータ表示**: 現在使用中のセーブデータ名
- **セーブデータリスト**: 
  - デフォルトデータ（削除不可表示）
  - ユーザー作成データ（並び替え可能）
- **アクションボタン**:
  - 新規作成、読み込み、名前変更、削除、並び替え
  - 現在のデータを保存、キャンセル

#### 2.3.2 セーブデータ操作フロー

**新規作成フロー**:
```
[新規作成] → 名前入力モーダル → 現在の入力内容をコピーして新規セーブデータ作成 → 作成されたデータに切り替え
```

**読み込みフロー**:
```
セーブデータ選択 → [読み込み] → 確認ダイアログ → 選択したデータを読み込み → UI状態更新
```

**名前変更フロー**:
```
セーブデータ選択 → [名前変更] → 名前変更モーダル → 名前更新
```

**削除フロー**:
```
セーブデータ選択 → [削除] → 確認ダイアログ → 削除実行 → リスト更新
```

**並び替えフロー**:
```
[並び替え] → ドラッグ&ドロップ形式の並び替えUI → [保存] → 順序更新
```

## 3. LocalStorage キー設計

### 3.1 キー一覧

```typescript
const STORAGE_KEYS = {
  // セーブデータ
  SAVE_DATA_LIST: 'toram_save_data_list',           // SaveData[]
  CURRENT_SAVE_ID: 'toram_current_save_id',         // string
  
  // ユーザーカスタムデータ
  CUSTOM_EQUIPMENTS: 'toram_custom_equipments',     // UserEquipment[]
  CUSTOM_CRYSTALS: 'toram_custom_crystals',         // UserCrystal[]
  
  // アプリケーション設定
  APP_SETTINGS: 'toram_app_settings',               // AppSettings
  VERSION: 'toram_storage_version'                  // string
} as const
```

### 3.2 データサイズ管理

**容量制限**:
- LocalStorageの一般的な制限: 5-10MB
- 推定データサイズ: 1セーブデータあたり約10-20KB
- 目安: 200-500個のセーブデータが保存可能

**容量監視**:
```typescript
interface StorageUsage {
  totalSize: number      // 使用中の総サイズ（バイト）
  maxSize: number       // 推定最大サイズ
  usage: number         // 使用率（0-1）
  warning: boolean      // 警告レベル（80%以上）
  critical: boolean     // 危険レベル（95%以上）
}
```

## 4. データ管理API設計

### 4.1 セーブデータ管理

```typescript
// src/utils/saveDataManager.ts

// セーブデータ操作
export function createSaveData(name: string, currentData: CalculatorData): Promise<SaveData>
export function loadSaveData(id: string): Promise<SaveData>
export function updateSaveData(id: string, data: Partial<SaveData>): Promise<void>
export function deleteSaveData(id: string): Promise<void>
export function renameSaveData(id: string, newName: string): Promise<void>

// セーブデータリスト管理
export function getAllSaveData(): SaveData[]
export function reorderSaveData(newOrder: string[]): Promise<void>
export function getCurrentSaveData(): SaveData
export function setCurrentSaveData(id: string): Promise<void>

// 自動保存
export function autoSaveCurrentData(data: CalculatorData): Promise<void>
export function enableAutoSave(): void
export function disableAutoSave(): void
```

### 4.2 ユーザーカスタムデータ管理

```typescript
// src/utils/customDataManager.ts

// ユーザー装備管理（既存のuserEquipmentManager.tsを拡張）
export function exportCustomEquipments(): string
export function importCustomEquipments(data: string): Promise<UserEquipment[]>

// ユーザークリスタル管理
export function createCustomCrystal(crystal: UserCrystal): Promise<void>
export function updateCustomCrystal(id: string, crystal: Partial<UserCrystal>): Promise<void>
export function deleteCustomCrystal(id: string): Promise<void>
export function getAllCustomCrystals(): UserCrystal[]
```

### 4.3 ストレージ管理

```typescript
// src/utils/storageManager.ts

// 容量管理
export function getStorageUsage(): StorageUsage
export function cleanupOldData(): Promise<void>
export function validateStorageIntegrity(): Promise<boolean>

// バックアップ・復元
export function exportAllData(): string
export function importAllData(data: string): Promise<void>
export function createBackup(): string
export function restoreFromBackup(backup: string): Promise<void>

// データ移行
export function migrateStorageVersion(fromVersion: string, toVersion: string): Promise<void>
export function getCurrentStorageVersion(): string
```

## 5. UI/UX設計

### 5.1 セーブデータ管理モーダル

**レイアウト構成**:
```
┌─────────────────────────────────────┐
│ セーブデータ管理                      │
├─────────────────────────────────────┤
│ 現在: メインデータ                    │
├─────────────────────────────────────┤
│ ☰ メインデータ (デフォルト) [読込]    │
│ ☰ キャラクタービルド1    [読込][編集][削除] │
│ ☰ 高レベル用セットアップ  [読込][編集][削除] │
│ ...                                │
├─────────────────────────────────────┤
│ [新規作成] [並び替え] [エクスポート]   │
│           [インポート] [キャンセル]    │
└─────────────────────────────────────┘
```

**セーブデータリスト項目**:
- ドラッグハンドル（☰）
- セーブデータ名
- 更新日時（相対時間表示）
- アクションボタン（読込、編集、削除）
- デフォルトデータは特別表示（削除ボタンなし）

### 5.2 名前入力モーダル

**新規作成用**:
```
┌─────────────────────────────────────┐
│ 新しいセーブデータを作成               │
├─────────────────────────────────────┤
│ セーブデータ名:                      │
│ [________________] (最大30文字)       │
│                                   │
│ 現在の入力内容をコピーして作成します     │
├─────────────────────────────────────┤
│              [作成] [キャンセル]      │
└─────────────────────────────────────┘
```

**名前変更用**:
```
┌─────────────────────────────────────┐
│ セーブデータ名を変更                  │
├─────────────────────────────────────┤
│ セーブデータ名:                      │
│ [現在の名前__________] (最大30文字)    │
├─────────────────────────────────────┤
│              [変更] [キャンセル]      │
└─────────────────────────────────────┘
```

### 5.3 確認ダイアログ

**削除確認**:
```
セーブデータ「{名前}」を削除しますか？
この操作は取り消せません。

[削除] [キャンセル]
```

**読み込み確認** (未保存の変更がある場合):
```
現在の変更内容が失われます。
セーブデータ「{名前}」を読み込みますか？

[読み込み] [キャンセル]
```

## 6. 自動保存システム

### 6.1 自動保存の仕組み

**保存タイミング**:
- フォーム入力値の変更から3秒後（デバウンス）
- ページを離れる前（beforeunload）
- 定期的な保存（5分間隔、バックグラウンド）

**保存対象**:
- 現在選択中のセーブデータにのみ自動保存
- 全フォームの入力状態を保存

```typescript
interface AutoSaveConfig {
  enabled: boolean          // 自動保存の有効/無効
  debounceMs: number       // デバウンス時間（ミリ秒）
  intervalMs: number       // 定期保存間隔（ミリ秒）
}
```

## 7. エラーハンドリング・データ整合性

### 7.1 データ検証

**保存時検証**:
```typescript
interface DataValidation {
  isValid: boolean
  errors: string[]
  warnings: string[]
}

export function validateSaveData(data: SaveData): DataValidation
export function validateCustomEquipment(equipment: UserEquipment): DataValidation
export function validateCustomCrystal(crystal: UserCrystal): DataValidation
```

**整合性チェック**:
- 必須フィールドの存在確認
- データ型の検証
- 値の範囲チェック
- 参照整合性の確認

### 7.2 エラー復旧

**データ破損対応**:
1. 破損データの検出
2. バックアップデータからの復旧試行
3. デフォルト値での初期化
4. ユーザーへの通知とオプション提示

**容量不足対応**:
1. 古いセーブデータの自動削除提案
2. エクスポート推奨
3. 不要データの削除支援

## 8. セキュリティ・プライバシー

### 8.1 データ保護

**ローカルストレージの特性**:
- ブラウザローカルに保存（外部送信なし）
- ドメイン別分離
- ユーザーによる削除可能

**注意事項**:
- ブラウザのプライベートモードでは永続化されない
- ブラウザデータ削除時に消失する可能性
- 端末間での同期は行われない

### 8.2 データのポータビリティ

**エクスポート機能**:
- JSON形式でのデータエクスポート
- 全データ一括、または選択的エクスポート
- 他の端末・ブラウザでのインポート対応

**インポート機能**:
- 形式検証とデータ整合性チェック
- 重複データの処理オプション
- インポート前のプレビュー機能

## 9. パフォーマンス最適化

### 9.1 読み書き最適化

**遅延読み込み**:
- 必要時のみデータを読み込み
- セーブデータリストは概要のみ先行読み込み
- 詳細データは選択時に読み込み

**バッチ処理**:
- 複数の変更をまとめて保存
- デバウンス処理による無駄な保存の削減

### 9.2 メモリ管理

**キャッシュ戦略**:
- 現在のセーブデータはメモリにキャッシュ
- 未使用のセーブデータは適時解放
- LRUキャッシュによる効率的なメモリ使用

## 10. 実装優先度

### Phase 1（高優先度）
- 基本的なセーブデータ CRUD 操作
- デフォルトセーブデータの自動保存
- セーブデータ管理UI

### Phase 2（中優先度）
- 並び替え機能
- エクスポート・インポート機能
- 自動保存システム

### Phase 3（低優先度）
- 高度な検索・フィルタリング
- データ分析・統計機能
- クラウド同期対応の準備

## 11. 技術仕様

### 11.1 依存関係

**依存パッケージ**:
- `uuid`: 一意ID生成
- `date-fns`: 日時処理
- `lodash.debounce`: デバウンス処理

**既存技術スタックとの統合**:
- Zod: データバリデーション
- React Hook Form: フォーム状態管理
- TypeScript: 型安全性

### 11.2 コンポーネント構成

```
SaveDataManager/
├── SaveDataModal.tsx              // セーブデータ管理モーダル
├── SaveDataList.tsx              // セーブデータリスト
├── SaveDataItem.tsx              // セーブデータ項目
├── SaveDataNameModal.tsx         // 名前入力モーダル
├── SaveDataSortable.tsx          // 並び替え機能
└── hooks/
    ├── useSaveDataManager.ts     // セーブデータ管理ロジック
    ├── useAutoSave.ts           // 自動保存ロジック
    └── useStorageMonitor.ts     // ストレージ監視
```

---

**作成日**: 2025-01-16
**対象システム**: トーラムオンライン ダメージ計算ツール
**設計対象**: ローカルストレージ・セーブデータ管理システム